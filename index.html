<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crispy Chicken â€” Magical Compensation Tickets Dashboard</title>
  
  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Custom CSS -->
  <style>
    :root {
      --crispy-red: #d32f2f;
      --crispy-dark: #b71c1c;
      --crispy-light: #ffebee;
      --crispy-accent: #ff7043;
      --crispy-purple: #7c4dff;
      --crispy-blue: #512da8;
      --crispy-green: #2e7d32;
      --crispy-yellow: #ef6c00;
      --bg: #fafafa;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 15px rgba(0,0,0,0.2);
      --magic-gradient: linear-gradient(135deg, var(--crispy-red), var(--crispy-accent));
      --magic-gradient-purple: linear-gradient(135deg, var(--crispy-purple), var(--crispy-blue));
    }
    
    html, body {
      height: 100%;
      background: var(--bg);
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text-primary);
      direction: ltr;
      overflow-x: hidden;
    }
    
    /* Magical Background */
    .magical-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
      overflow: hidden;
    }
    
    .magical-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(211,47,47,0.05) 0%, transparent 70%);
      animation: magicalRotate 30s linear infinite;
    }
    
    @keyframes magicalRotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Enhanced Navbar */
    .navbar {
      background: var(--magic-gradient);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 1rem 0;
      position: relative;
      z-index: 1000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .navbar .navbar-brand {
      color: #fff;
      font-weight: 700;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .navbar .navbar-brand i {
      font-size: 1.8rem;
      animation: magicalPulse 2s infinite;
    }
    
    @keyframes magicalPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .container-page {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }
    
    /* Magical Cards */
    .card-ghost {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .card-ghost::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: var(--magic-gradient);
      border-radius: 20px;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s ease;
    }
    
    .card-ghost:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .card-ghost:hover::before {
      opacity: 0.1;
    }
    
    /* Enhanced Stats Section */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      padding: 30px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(211,47,47,0.05), rgba(211,47,47,0.1));
      border-left: 8px solid var(--crispy-red);
      box-shadow: var(--shadow);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top right, rgba(255,112,67,0.1) 0%, transparent 70%);
      pointer-events: none;
    }
    
    .stat-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }
    
    .stat-card h2 {
      font-size: 2.8rem;
      font-weight: 700;
      margin: 15px 0;
      background: var(--magic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      position: relative;
      z-index: 1;
    }
    
    .stat-card .text-muted {
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }
    
    /* Magical Platform Cards */
    .platform-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .platform-card {
      padding: 40px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(255,112,67,0.05), rgba(255,112,67,0.1));
      text-align: center;
      box-shadow: var(--shadow);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    
    .platform-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,112,67,0.1) 0%, transparent 70%);
      animation: magicalRotate 40s linear infinite reverse;
    }
    
    .platform-card:hover {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 20px 40px rgba(255,112,67,0.2);
    }
    
    .platform-card h3 {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 20px 0;
      background: var(--magic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      position: relative;
      z-index: 1;
    }
    
    .platform-card .percentage {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--crispy-accent);
      margin-top: 10px;
      position: relative;
      z-index: 1;
    }
    
    /* Enhanced Reports Section */
    #reports {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }
    
    .report-card {
      padding: 30px;
      border-radius: 20px;
      background: var(--card-bg);
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .report-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--magic-gradient);
    }
    
    .report-card h5 {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 25px;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .report-card .chart-container {
      position: relative;
      height: 250px;
    }
    
    /* Enhanced Case Analysis */
    .case-analysis-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 40px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .case-analysis-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--magic-gradient-purple);
    }
    
    .case-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .case-analysis-header h5 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .case-badge {
      padding: 10px 20px;
      border-radius: 30px;
      font-size: 0.95rem;
      font-weight: 600;
      position: relative;
      z-index: 1;
      transition: all 0.3s ease;
    }
    
    .badge-high {
      background: linear-gradient(135deg, var(--crispy-light), rgba(255,235,238,0.5));
      color: var(--crispy-red);
      box-shadow: 0 4px 15px rgba(211,47,47,0.2);
    }
    
    .badge-medium {
      background: linear-gradient(135deg, #fff3e0, rgba(255,243,224,0.5));
      color: #ef6c00;
      box-shadow: 0 4px 15px rgba(239,108,0,0.2);
    }
    
    .badge-low {
      background: linear-gradient(135deg, #e8f5e9, rgba(232,245,233,0.5));
      color: #2e7d32;
      box-shadow: 0 4px 15px rgba(46,125,50,0.2);
    }
    
    .case-badge:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .branch-analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 30px;
    }
    
    .branch-card {
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .branch-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--magic-gradient);
    }
    
    .branch-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .branch-card h6 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--crispy-dark);
      position: relative;
      z-index: 1;
    }
    
    .branch-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .branch-stat-item {
      text-align: center;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .branch-stat-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .branch-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--crispy-red);
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }
    
    .branch-stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      position: relative;
      z-index: 1;
    }
    
    .case-reasons {
      margin-top: 25px;
    }
    
    .case-reasons h6 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .case-reason-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .case-reason-item:hover {
      background: rgba(0,0,0,0.02);
      padding-left: 10px;
      padding-right: 10px;
      margin: 0 -10px;
      border-radius: 8px;
    }
    
    .case-reason-item:last-child {
      border-bottom: none;
    }
    
    .case-reason-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      flex: 1;
    }
    
    .case-reason-name {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .case-reason-count {
      font-size: 0.9rem;
      color: var(--text-secondary);
      position: relative;
      z-index: 1;
    }
    
    .case-reason-bar {
      width: 100%;
      height: 10px;
      background: #e9ecef;
      border-radius: 5px;
      margin-top: 8px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    
    .case-reason-progress {
      height: 100%;
      background: var(--magic-gradient);
      border-radius: 5px;
      transition: width 1s ease-out;
    }
    
    /* Enhanced Tickets Section */
    .tickets-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      margin-bottom: 40px;
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .tickets-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--magic-gradient-purple);
    }
    
    .tickets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .tickets-header h5 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .tickets-header .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      flex: 1;
      margin-bottom: 20px;
    }
    
    .tickets-header .search-input {
      min-width: 220px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .tickets-header .search-input:focus {
      border-color: var(--crispy-red);
      box-shadow: 0 0 0 3px rgba(211,47,47,0.1);
    }
    
    .tickets-header .filter-select {
      min-width: 180px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }
    
    .tickets-header .filter-select:focus {
      border-color: var(--crispy-red);
      box-shadow: 0 0 0 3px rgba(211,47,47,0.1);
    }
    
    .tickets-header .action-buttons {
      display: flex;
      gap: 12px;
    }
    
    .tickets-header .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .tickets-header .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .tickets-header .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .tickets-header .btn-primary {
      background: var(--magic-gradient);
      color: white;
      border: none;
    }
    
    .tickets-header .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(211,47,47,0.3);
    }
    
    /* Enhanced Scrollable Table */
    .scrollable-table-container {
      max-height: 650px;
      overflow-y: auto;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      background: var(--card-bg);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      transition: all 0.3s ease;
    }
    
    .scrollable-table-container:hover {
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    
    .tickets-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card-bg);
      font-size: 0.95rem;
    }
    
    .tickets-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--magic-gradient);
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tickets-table th {
      padding: 18px 16px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      position: relative;
      font-size: 0.95rem;
    }
    
    .tickets-table th:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 70%;
      width: 1px;
      background: rgba(255, 255, 255, 0.2);
    }
    
    .tickets-table td {
      padding: 18px 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      vertical-align: middle;
      transition: all 0.2s ease;
    }
    
    .tickets-table tbody tr {
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .tickets-table tbody tr:hover {
      background: rgba(0, 0, 0, 0.02);
      transform: scale(1.005);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .ticket-order-id {
      font-weight: 700;
      color: var(--crispy-dark);
      font-size: 1.1rem;
    }
    
    .ticket-issue {
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      vertical-align: middle;
    }
    
    .issue-expand {
      background: none;
      border: none;
      color: var(--crispy-blue);
      text-decoration: underline;
      font-size: 0.9rem;
      cursor: pointer;
      padding-left: 8px;
      transition: all 0.2s ease;
    }
    
    .issue-expand:hover {
      color: var(--crispy-purple);
      transform: translateX(3px);
    }
    
    .ticket-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    
    .ticket-actions .btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .ticket-actions .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    /* Enhanced Status Badges */
    .status-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .status-open {
      background: linear-gradient(135deg, rgba(13,110,253,0.1), rgba(13,110,253,0.2));
      color: #0d6efd;
      box-shadow: 0 2px 8px rgba(13,110,253,0.2);
    }
    
    .status-sent {
      background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,193,7,0.2));
      color: #ffc107;
      box-shadow: 0 2px 8px rgba(255,193,7,0.2);
    }
    
    .status-closed {
      background: linear-gradient(135deg, rgba(25,135,84,0.1), rgba(25,135,84,0.2));
      color: #198754;
      box-shadow: 0 2px 8px rgba(25,135,84,0.2);
    }
    
    .status-rejected {
      background: linear-gradient(135deg, rgba(220,53,69,0.1), rgba(220,53,69,0.2));
      color: #dc3545;
      box-shadow: 0 2px 8px rgba(220,53,69,0.2);
    }
    
    .status-restaurant-fault {
      background: linear-gradient(135deg, rgba(255,193,7,0.1), rgba(255,193,7,0.2));
      color: #ffc107;
      box-shadow: 0 2px 8px rgba(255,193,7,0.2);
    }
    
    /* Enhanced Modal */
    .modal-content {
      border-radius: 20px;
      border: none;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      overflow: hidden;
      position: relative;
    }
    
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--magic-gradient);
    }
    
    .modal-header {
      background: var(--magic-gradient);
      color: #fff;
      border-radius: 20px 20px 0 0;
      padding: 25px 30px;
      position: relative;
    }
    
    .modal-header .modal-title {
      font-weight: 700;
      font-size: 1.4rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .modal-body {
      padding: 30px;
    }
    
    .form-label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 10px;
      color: var(--text-primary);
      position: relative;
    }
    
    .form-label::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--crispy-red);
      border-radius: 2px;
    }
    
    .form-control, .form-select {
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--crispy-red);
      box-shadow: 0 0 0 3px rgba(211,47,47,0.1);
      background: white;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .modal-footer .btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 12px 24px;
      transition: all 0.3s ease;
    }
    
    /* Enhanced Dock */
    #dock {
      position: fixed;
      right: 30px;
      bottom: 30px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: flex-end;
    }
    
    .dock-toggle {
      width: 65px;
      height: 65px;
      border-radius: 50%;
      background: var(--magic-gradient);
      color: #fff;
      border: none;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    
    .dock-toggle::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .dock-toggle:hover::before {
      width: 100px;
      height: 100px;
    }
    
    .dock-toggle:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    
    .dock-panel {
      display: none;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      width: 280px;
      max-height: 80vh;
      overflow-y: auto;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .dock-panel.show {
      display: flex;
      animation: magicalSlideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes magicalSlideUp {
      from {
        transform: translateY(40px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
    
    .dock-panel button {
      width: 100%;
      padding: 15px 20px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      background: white;
      color: var(--text-primary);
      border: 1px solid rgba(0,0,0,0.1);
      text-align: left;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }
    
    .dock-panel button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: var(--magic-gradient);
      transition: width 0.4s ease;
      z-index: -1;
    }
    
    .dock-panel button:hover::before {
      width: 100%;
    }
    
    .dock-panel button:hover {
      transform: translateX(-5px);
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .dock-panel button i {
      font-size: 1.2rem;
      z-index: 1;
    }
    
    .dock-panel button span {
      z-index: 1;
    }
    
    /* Enhanced Notifications */
    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      padding: 20px 25px;
      border-radius: 15px;
      color: #fff;
      z-index: 3000;
      display: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-width: 400px;
      font-weight: 500;
      animation: magicalSlideIn 0.5s ease-out;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .notification.show {
      display: block;
    }
    
    .notification.success {
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
      border-left: 5px solid #2e7d32;
    }
    
    .notification.error {
      background: linear-gradient(135deg, #d32f2f, #ef5350);
      border-left: 5px solid #d32f2f;
    }
    
    .notification.warning {
      background: linear-gradient(135deg, #ef6c00, #ffb74d);
      border-left: 5px solid #ef6c00;
    }
    
    .notification.info {
      background: linear-gradient(135deg, #512da8, #7c4dff);
      border-left: 5px solid #512da8;
    }
    
    @keyframes magicalSlideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Enhanced Back to Top Button */
    .back-to-top {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--magic-gradient);
      color: white;
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
    }
    
    .back-to-top:hover {
      transform: translateY(-8px) scale(1.1);
      box-shadow: 0 15px 40px rgba(0,0,0,0.3);
      background: linear-gradient(135deg, var(--crispy-dark), var(--crispy-red));
    }
    
    .back-to-top.show {
      display: flex;
      animation: magicalFadeInUp 0.5s ease-out;
    }
    
    @keyframes magicalFadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Enhanced Summary Section */
    .summary-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 40px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .summary-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: var(--magic-gradient-purple);
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .summary-header h5 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }
    
    .summary-card {
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: var(--magic-gradient);
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .summary-card h6 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--crispy-dark);
      position: relative;
      z-index: 1;
    }
    
    .summary-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .metric-item {
      text-align: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .metric-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      background: var(--magic-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }
    
    .metric-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      position: relative;
      z-index: 1;
    }
    
    .metric-change {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 5px;
      position: relative;
      z-index: 1;
    }
    
    .metric-change.positive {
      color: var(--crispy-green);
    }
    
    .metric-change.negative {
      color: var(--crispy-red);
    }
    
    .metric-change.neutral {
      color: var(--muted);
    }
    
    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 25px;
    }
    
    .mini-chart {
      height: 180px;
      position: relative;
      z-index: 1;
    }
    
    /* Enhanced Refund Analysis */
    .refund-analysis-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 40px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .refund-analysis-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
    }
    
    .refund-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .refund-card {
      background: linear-gradient(135deg, #f8f9fa, #ffffff);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .refund-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
    }
    
    .refund-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .refund-card h6 {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--crispy-dark);
      position: relative;
      z-index: 1;
    }
    
    .refund-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .refund-metric-item {
      text-align: center;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .refund-metric-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .refund-metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }
    
    .refund-metric-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      position: relative;
      z-index: 1;
    }
    
    .refund-chart-container {
      height: 220px;
      margin-top: 25px;
      position: relative;
      z-index: 1;
    }
    
    .refund-table-container {
      margin-top: 25px;
      max-height: 350px;
      overflow-y: auto;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .refund-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .refund-table th {
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .refund-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      transition: all 0.2s ease;
    }
    
    .refund-table tr:hover {
      background: rgba(46,125,50,0.05);
    }
    
    .refund-status-badge {
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
      box-shadow: 0 2px 8px rgba(46,125,50,0.2);
    }
    
    /* Enhanced Restaurant Fault Section */
    .restaurant-fault-section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 35px;
      margin-bottom: 40px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .restaurant-fault-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(135deg, #ef6c00, #ffb74d);
    }
    
    /* Print styles */
    @media print {
      #dock, .tickets-header .btn, .action-buttons, .navbar, .modal, .notification, .commands-window, .storage-indicator { display:none !important; }
      body{background:#fff}
      .card-ghost{box-shadow:none;border:1px solid #ddd;}
    }
    
    /* Responsive styles */
    @media (max-width: 1200px){
      .container-page{max-width:100%;padding:0 16px;}
      .tickets-table-container {
        height: 500px;
      }
      .ticket-issue {
        max-width: 200px;
      }
    }
    @media (max-width: 992px){
      #reports{grid-template-columns:1fr;}
      .branch-analysis-grid{grid-template-columns:1fr;}
      .branch-stats{grid-template-columns:repeat(2,1fr);}
      .summary-grid{grid-template-columns:1fr;}
      .chart-row{grid-template-columns:1fr;}
      .refund-grid{grid-template-columns:1fr;}
      .compensation-analysis-grid{grid-template-columns:1fr;}
      .rejection-analysis-grid{grid-template-columns:1fr;}
      .all-commands-container { 
        margin-top: 160px;
        margin-right: 0;
      }
      .tickets-table-container {
        height: 400px;
      }
      .tickets-table th,
      .tickets-table td {
        padding: 12px 8px;
        font-size: 0.9rem;
      }
      .ticket-issue {
        max-width: 150px;
      }
      .ticket-actions {
        flex-direction: column;
        gap: 4px;
      }
    }
    @media (max-width: 768px){
      .stats-grid{grid-template-columns:1fr;}
      .platform-cards{grid-template-columns:1fr;}
      .tickets-header .filters{flex-direction:column;align-items:stretch;}
      .tickets-header .search-input,.tickets-header .filter-select{min-width:100%;}
      .tickets-header .action-buttons{justify-content:stretch;}
      .tickets-header .action-buttons .btn{flex:1;}
      .tickets-table{font-size:0.85rem;}
      .ticket-actions{justify-content:center;}
      #dock{right:16px;bottom:16px;}
      .dock-panel{width:180px;}
      .dock-panel button{min-width:160px;font-size:0.9rem;}
      .commands-window {
        width: 280px;
        right: 16px;
        bottom: 16px;
      }
      .all-commands-container { 
        margin-top: 140px;
        margin-right: 0;
      }
      .tickets-table-container {
        height: 350px;
      }
      .tickets-table th,
      .tickets-table td {
        padding: 10px 6px;
      }
      .ticket-issue {
        max-width: 120px;
      }
      .ticket-actions .btn {
        font-size: 0.75rem;
        padding: 4px 6px;
      }
    }
    @media (max-width: 576px){
      .container-page{padding:0 12px;}
      .card-ghost{padding:16px;}
      .stat-card h2{font-size:2rem;}
      .platform-card h3{font-size:1.8rem;}
      .report-card{padding:16px;}
      .tickets-table th,.tickets-table td{padding:8px 4px;}
      .ticket-issue{max-width:80px;}
      .all-commands-container { 
        margin-top: 120px;
        margin-right: 0;
      }
      .tickets-table-container {
        height: 300px;
      }
      .tickets-table {
        font-size: 0.8rem;
      }
      .ticket-actions {
        gap: 2px;
      }
      .ticket-actions .btn {
        padding: 3px 5px;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Magical Background -->
  <div class="magical-bg"></div>
  
  <!-- Storage Indicator -->
  <div id="storageIndicator" class="storage-indicator">0% storage used</div>
  
  <!-- Enhanced Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container container-page">
      <a class="navbar-brand" href="#">
        <i class="bi bi-fire-fill"></i>
        Crispy Chicken â€” Magical Compensation Tickets
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link text-white fw-semibold" href="#">Dashboard</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Main Content -->
  <main class="container-page">
    <!-- Enhanced Stats Section -->
    <section class="stats-grid">
      <div class="stat-card text-center">
        <div class="text-muted">Total Cases</div>
        <h2 id="totalTickets">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#0d6efd;">
        <div class="text-muted">Open</div>
        <h2 id="openTickets" style="color:#0d6efd;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#ffc107;">
        <div class="text-muted">Sent</div>
        <h2 id="sentTickets" style="color:#ffc107;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#198754;">
        <div class="text-muted">Closed</div>
        <h2 id="closedTickets" style="color:#198754;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#28a745;">
        <div class="text-muted">Resolved Disputes</div>
        <h2 id="resolvedDisputes" style="color:#28a745;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#17a2b8;">
        <div class="text-muted">Active Compensations</div>
        <h2 id="activeCompensations" style="color:#17a2b8;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#dc3545;">
        <div class="text-muted">Total Compensation</div>
        <h2 id="totalCompensationAmount" style="color:#dc3545;">0</h2>
      </div>
      <div class="stat-card text-center" style="border-left-color:#ffc107;">
        <div class="text-muted">Restaurant Fault</div>
        <h2 id="restaurantFaultCases" style="color:#ffc107;">0</h2>
      </div>
    </section>
    
    <!-- Enhanced Summary Section -->
    <section class="summary-section">
      <div class="summary-header">
        <h5>Magical Dashboard Summary</h5>
        <div class="text-muted">
          <i class="bi bi-calendar3"></i>
          <span id="summaryDate"></span>
        </div>
      </div>
      <div class="summary-grid">
        <div class="summary-card">
          <h6>Financial Overview</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="totalOriginalAmount">0</div>
              <div class="metric-label">Total Original Amount</div>
              <div class="metric-change" id="originalAmountChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalCompensation">0</div>
              <div class="metric-label">Total Compensation</div>
              <div class="metric-change" id="compensationChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="totalRefunded">0</div>
              <div class="metric-label">Total Refunded</div>
              <div class="metric-change" id="refundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="netCompensation">0</div>
              <div class="metric-label">Net Compensation</div>
              <div class="metric-change" id="netCompensationChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="amountChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Platform Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="noonTickets">0</div>
              <div class="metric-label">Noon Cases</div>
              <div class="metric-change" id="noonTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemTickets">0</div>
              <div class="metric-label">Careem Cases</div>
              <div class="metric-change" id="careemTicketsChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="noonRefunded">0</div>
              <div class="metric-label">Noon Refunded</div>
              <div class="metric-change" id="noonRefundedChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="careemRefunded">0</div>
              <div class="metric-label">Careem Refunded</div>
              <div class="metric-change" id="careemRefundedChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="platformTicketsChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="platformCompensationChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="summary-card">
          <h6>Branch Performance</h6>
          <div class="summary-metrics">
            <div class="metric-item">
              <div class="metric-value" id="topBranch">-</div>
              <div class="metric-label">Top Branch</div>
              <div class="metric-change" id="topBranchCases">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="topCase">-</div>
              <div class="metric-label">Top Case</div>
              <div class="metric-change" id="topCaseCount">0 cases</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="caseRate">0%</div>
              <div class="metric-label">Case Rate</div>
              <div class="metric-change" id="caseRateChange">+0%</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="avgOriginalAmount">0</div>
              <div class="metric-label">Avg. Original Amount</div>
              <div class="metric-change" id="avgOriginalAmountChange">+0%</div>
            </div>
          </div>
          <div class="chart-row">
            <div class="mini-chart">
              <canvas id="branchCasesChart"></canvas>
            </div>
            <div class="mini-chart">
              <canvas id="caseTypesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Platform Cards -->
    <section class="platform-cards">
      <div class="platform-card">
        <div class="text-muted">Noon Cases</div>
        <h3 id="noonCount">0</h3>
        <div class="percentage" id="noonPercentage">0%</div>
      </div>
      <div class="platform-card">
        <div class="text-muted">Careem Cases</div>
        <h3 id="careemCount">0</h3>
        <div class="percentage" id="careemPercentage">0%</div>
      </div>
    </section>
    
    <!-- Enhanced Reports Section -->
    <section id="reports">
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Top Branches by Cases</h5>
          <small class="text-muted" id="topBranchLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="branchChart"></canvas>
        </div>
      </div>
      <div class="report-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Case Types Breakdown</h5>
          <small class="text-muted" id="topCaseLabel"></small>
        </div>
        <div class="chart-container">
          <canvas id="caseChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Case Analysis -->
    <section class="case-analysis-section">
      <div class="case-analysis-header">
        <h5>Magical Case Analysis</h5>
        <div id="caseAnalysisBadge" class="case-badge badge-high">High Level</div>
      </div>
      <div id="branchAnalysisContainer"></div>
    </section>
    
    <!-- Compensation Analysis Section -->
    <section class="compensation-analysis-section">
      <div class="compensation-analysis-header">
        <h5>Compensation Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-bar-chart"></i>
          Breakdown of compensation cases
        </div>
      </div>
      <div id="compensationAnalysisContainer"></div>
    </section>
    
    <!-- Rejection Analysis Section -->
    <section class="rejection-analysis-section">
      <div class="rejection-analysis-header">
        <h5>Rejection Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-x-circle"></i>
          Analysis of rejected compensation cases
        </div>
      </div>
      <div id="rejectionAnalysisContainer"></div>
    </section>
    
    <!-- Restaurant Fault Analysis Section -->
    <section class="restaurant-fault-section">
      <div class="rejection-analysis-header">
        <h5>Restaurant Fault Cases</h5>
        <div class="text-muted">
          <i class="bi bi-exclamation-triangle"></i>
          Cases where restaurant bears the cost
        </div>
      </div>
      <div id="restaurantFaultContainer"></div>
    </section>
    
    <!-- Refund Analysis Section -->
    <section class="refund-analysis-section">
      <div class="refund-analysis-header">
        <h5>Refund Analysis</h5>
        <div class="text-muted">
          <i class="bi bi-arrow-repeat"></i>
          Refunded Compensation Tracking
        </div>
      </div>
      <div class="refund-grid">
        <div class="refund-card">
          <h6>Overall Refunds</h6>
          <div class="refund-metrics">
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="totalRefundedAmount">0</div>
              <div class="refund-metric-label">Total Refunded Amount</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundedCasesCount">0</div>
              <div class="refund-metric-label">Refunded Cases</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="refundRate">0%</div>
              <div class="refund-metric-label">Refund Rate</div>
            </div>
            <div class="refund-metric-item">
              <div class="refund-metric-value" id="avgRefundedAmount">0</div>
              <div class="refund-metric-label">Avg. Refunded Amount</div>
            </div>
          </div>
        </div>
        
        <div class="refund-card">
          <h6>Refunds by Branch</h6>
          <div class="refund-chart-container">
            <canvas id="refundBranchChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="refund-table-container">
        <table class="refund-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Branch</th>
              <th>Original Amount</th>
              <th>Compensation</th>
              <th>Refunded Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="refundTableBody">
          </tbody>
        </table>
      </div>
    </section>
    
    <!-- Enhanced Tickets Section -->
    <section class="tickets-section">
      <div class="tickets-header">
        <h5>Magical Compensation Cases</h5>
        <div class="filters">
          <input id="searchInput" class="form-control search-input" placeholder="Search case / branch / issue" />
          <select id="filterBranch" class="form-select filter-select">
            <option value="">All Branches</option>
          </select>
          <select id="filterPlatform" class="form-select filter-select">
            <option value="">All Platforms</option>
            <option>Noon</option>
            <option>Careem</option>
          </select>
          <select id="filterStatus" class="form-select filter-select">
            <option value="">All Status</option>
            <option>Open</option>
            <option>Sent</option>
            <option>Closed</option>
            <option>Rejected</option>
            <option>Restaurant Fault</option>
          </select>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle"></i> Add
            </button>
            <button class="btn btn-outline-secondary" onclick="addSample()">
              <i class="bi bi-flask"></i> Sample
            </button>
          </div>
        </div>
      </div>
      
      <!-- Scrollable Table Container -->
      <div class="scrollable-table-container">
        <table class="tickets-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Order Date</th>
              <th>Branch</th>
              <th>Platform</th>
              <th>Case</th>
              <th>Evidence</th>
              <th>Status</th>
              <th>Original Amount</th>
              <th>Compensation</th>
              <th>Refunded</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ticketsTableBody">
          </tbody>
        </table>
      </div>
    </section>
  </main>
  
  <!-- Enhanced Modal -->
  <div class="modal fade" id="ticketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Magical Compensation Case</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="ticketForm">
            <input type="hidden" id="editingId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Order ID</label>
                <input id="f_orderId" class="form-control" required>
                <div id="duplicateWarning" class="duplicate-warning text-danger mt-1"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Order Date & Time</label>
                <input id="f_orderDate" type="datetime-local" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Branch</label>
                <select id="f_branch" class="form-select" required>
                  <option value="">Select Branch</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Platform</label>
                <select id="f_platform" class="form-select" required>
                  <option value="">Select Platform</option>
                  <option>Noon</option>
                  <option>Careem</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Case Description</label>
                <textarea id="f_issue" class="form-control autogrow" required></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Original Amount (AED)</label>
                <input id="f_originalAmount" type="number" min="0" step="0.01" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Compensation (AED)</label>
                <input id="f_compensation" type="number" min="0" step="0.01" class="form-control" required>
              </div>
              
              <!-- Refund Section -->
              <div class="col-md-6">
                <label class="form-label">Refunded Amount (AED)</label>
                <input id="f_refundedAmount" type="number" min="0" step="0.01" class="form-control" value="0">
                <div class="form-check mt-2">
                  <input id="f_isRefunded" type="checkbox" class="form-check-input">
                  <label class="form-check-label" for="f_isRefunded">Mark as refunded</label>
                </div>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Refund Date</label>
                <input id="f_refundDate" type="date" class="form-control">
              </div>
              
              <!-- Evidence Section -->
              <div class="col-12">
                <label class="form-label">Evidence</label>
                <div class="image-upload-container" onclick="document.getElementById('f_evidenceImage').click()">
                  <i class="bi bi-cloud-upload" style="font-size:2rem;color:#ccc"></i>
                  <p class="mb-0 mt-2">Click to upload image</p>
                  <input type="file" id="f_evidenceImage" accept="image/*" onchange="handleImageUpload(event)">
                  <img id="imagePreview" class="image-preview" style="display:none">
                </div>
                
                <div class="short-link-container">
                  <label class="form-label">Short Link</label>
                  <div style="position:relative;">
                    <input id="f_shortLink" type="text" class="form-control short-link-input" placeholder="Click 'Generate' to create short link" readonly>
                    <button type="button" class="short-link-button" onclick="generateShortLink()">
                      <i class="bi bi-link-45deg"></i> Generate
                    </button>
                  </div>
                </div>
                
                <div class="form-check mt-2">
                  <input id="f_noEvidence" type="checkbox" class="form-check-input">
                  <label class="form-check-label" for="f_noEvidence">No evidence</label>
                </div>
              </div>
              
              <div class="col-12 mt-3 d-flex gap-2 justify-content-end">
                <button type="submit" class="btn btn-danger">Save</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Issue Modal -->
  <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Case Details</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="issueText" style="white-space:pre-wrap;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Daily Branch Summary Modal -->
  <div class="modal fade" id="dailySummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Daily Branch Summary</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body daily-summary-modal">
          <div id="dailySummaryContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="exportDailySummary()">Export Summary</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Enhanced Dock -->
  <div id="dock" title="Drag me">
    <div id="dockPanel" class="dock-panel" role="toolbar" aria-hidden="true">
      <button class="btn btn-danger" onclick="openAddModal()" title="New Case">
        <i class="bi bi-plus-circle"></i> New Case
      </button>
      <button class="btn btn-outline-primary" onclick="addSample()" title="Add sample cases">
        <i class="bi bi-flask"></i> Add Sample
      </button>
      <button class="btn btn-outline-secondary" onclick="showDailySummary()" title="Daily branch summary">
        <i class="bi bi-calendar-day"></i> Daily Summary
      </button>
      <button class="btn btn-outline-danger" onclick="openRejectionModal()" title="Reject compensation">
        <i class="bi bi-x-circle"></i> Reject Compensation
      </button>
      <button class="btn btn-outline-warning" onclick="openRestaurantFaultModal()" title="Restaurant fault case">
        <i class="bi bi-exclamation-triangle"></i> Restaurant Fault
      </button>
      <button class="btn btn-outline-secondary" onclick="resetAll()" title="Reset all data">
        <i class="bi bi-arrow-clockwise"></i> Reset
      </button>
      <button class="btn btn-outline-dark" onclick="printReport()" title="Print report">
        <i class="bi bi-printer"></i> Print
      </button>
      <button class="btn btn-success" onclick="exportExcel()" title="Export Excel (XLSX)">
        <i class="bi bi-file-earmark-spreadsheet"></i> Export Excel
      </button>
      <button class="btn btn-warning" onclick="exportPDF()" title="Export PDF">
        <i class="bi bi-file-earmark-pdf"></i> Export PDF
      </button>
      <button class="btn btn-primary" onclick="exportDashboardSummary()" title="Dashboard Summary PDF">
        <i class="bi bi-file-text"></i> Dashboard PDF
      </button>
      <button id="heatmapToggleBtn" class="btn btn-outline-danger" onclick="toggleHeatmap()" title="Toggle Heatmap">
        <i class="bi bi-activity"></i> Heatmap
      </button>
      <button class="btn btn-outline-secondary" onclick="exportUsabilityLog()" title="Export user interactions">
        <i class="bi bi-box-arrow-up-right"></i> Export Log
      </button>
      <button class="btn btn-outline-info" onclick="clearCommands()" title="Clear commands">
        <i class="bi bi-trash"></i> Clear Commands
      </button>
      <button class="btn btn-outline-info" onclick="showStorageInfo()" title="Storage Info">
        <i class="bi bi-hdd"></i> Storage
      </button>
    </div>
    <button id="dockToggle" class="dock-toggle" title="Open actions">
      <i class="bi bi-gear-fill"></i>
    </button>
  </div>
  
  <!-- Enhanced Back to Top Button -->
  <button id="backToTop" class="back-to-top" onclick="scrollToTop()">
    <i class="bi bi-arrow-up"></i>
  </button>
  
  <!-- Enhanced Notification -->
  <div id="notification" class="notification"></div>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.js"></script>
  
  <script>
    // ===== State & initial data =====
    let tickets = JSON.parse(localStorage.getItem('crispyTickets')) || [];
    const branchWhats = {
      "Crispy Chicken Khalidiya": "971569494764",
      "Crispy Chicken Muroor": "971505414641",
      "Crispy Chicken Shabiya 11": "971562690688",
      "Crispy Chicken Al Barsha": "971569659524",
      "Crispy Chicken Al Satwa": "971567970685",
      "Crispy Chicken Electra": "971563866859",
      "Crispy Chicken Hamdan": "971556886650",
      "Crispy Chicken-Al Khalidiya": "971569494764"
    };
    const branchesList = Object.keys(branchWhats);
    
    // ===== DOM refs =====
    const ticketsTableBody = document.getElementById('ticketsTableBody');
    const searchInput = document.getElementById('searchInput');
    const filterBranch = document.getElementById('filterBranch');
    const filterPlatform = document.getElementById('filterPlatform');
    const filterStatus = document.getElementById('filterStatus');
    const notification = document.getElementById('notification');
    const dockToggle = document.getElementById('dockToggle');
    const dockPanel = document.getElementById('dockPanel');
    const dock = document.getElementById('dock');
    
    // Charts
    let branchChart = null, caseChart = null;
    let amountChart = null, statusChart = null;
    let platformTicketsChart = null, platformCompensationChart = null;
    let branchCasesChart = null, caseTypesChart = null;
    let refundBranchChart = null;
    
    // Commands tracking
    let commands = [];
    const MAX_COMMANDS_VISIBLE = 3;
    
    // Init setup
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Initializing magical application...');
      
      populateBranchFilters();
      
      // Load data from localStorage with error handling
      try {
        const storedTickets = localStorage.getItem('crispyTickets');
        if (storedTickets) {
          tickets = JSON.parse(storedTickets);
          console.log('Loaded tickets:', tickets.length);
        } else {
          console.log('No stored tickets found');
        }
      } catch (error) {
        console.error('Error loading tickets from localStorage:', error);
        tickets = [];
      }
      
      // If no data, add samples
      if (tickets.length === 0) {
        console.log('No tickets found, adding sample data...');
        addSample();
      } else {
        // If data exists, update interface
        renderAll();
      }
      
      setupListeners();
      updateSummaryDate();
      
      // Initialize commands display
      updateCommandsDisplay();
      
      // Initialize storage indicator
      updateStorageIndicator();
      
      // Initialize magical effects
      initializeMagicalEffects();
      
      console.log('Magical application initialized successfully');
    });
    
    // ===== Magical Effects Initialization =====
    function initializeMagicalEffects() {
      // Add particle effect to background
      createParticleEffect();
      
      // Add floating elements
      createFloatingElements();
      
      // Add magical glow effects
      addMagicalGlow();
    }
    
    function createParticleEffect() {
      const container = document.querySelector('.magical-bg');
      const particles = [];
      
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.style.position = 'absolute';
        particle.style.width = Math.random() * 10 + 5 + 'px';
        particle.style.height = particle.style.width;
        particle.style.background = 'rgba(211, 47, 47, 0.1)';
        particle.style.borderRadius = '50%';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animation = `float ${Math.random() * 10 + 10}s linear infinite`;
        particle.style.animationDelay = Math.random() * 10 + 's';
        
        container.appendChild(particle);
        particles.push(particle);
      }
    }
    
    function createFloatingElements() {
      const container = document.querySelector('.magical-bg');
      
      // Create floating shapes
      for (let i = 0; i < 5; i++) {
        const shape = document.createElement('div');
        shape.style.position = 'absolute';
        shape.style.width = Math.random() * 100 + 50 + 'px';
        shape.style.height = shape.style.width;
        shape.style.background = 'linear-gradient(135deg, rgba(211,47,47,0.05), rgba(255,112,67,0.05))';
        shape.style.borderRadius = Math.random() > 0.5 ? '50%' : '20%';
        shape.style.left = Math.random() * 100 + '%';
        shape.style.top = Math.random() * 100 + '%';
        shape.style.animation = `float ${Math.random() * 20 + 20}s linear infinite`;
        shape.style.animationDelay = Math.random() * 20 + 's';
        shape.style.filter = 'blur(40px)';
        
        container.appendChild(shape);
      }
    }
    
    function addMagicalGlow() {
      // Add glow effect to important elements
      document.querySelectorAll('.stat-card, .platform-card, .report-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.boxShadow = '0 0 30px rgba(211, 47, 47, 0.3)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.boxShadow = '';
        });
      });
    }
    
    // ===== Storage Management Functions =====
    
    // Check storage quota
    function checkStorageQuota() {
      try {
        const data = JSON.stringify(tickets);
        const dataString = 'crispyTickets=' + data;
        
        // Check if data exceeds typical localStorage limits (5MB)
        if (dataString.length > 4.5 * 1024 * 1024) { // 4.5MB limit
          console.warn('Storage quota approaching limit:', (dataString.length / 1024 / 1024).toFixed(2) + 'MB');
          return false;
        }
        return true;
      } catch (error) {
        console.error('Error checking storage quota:', error);
        return false;
      }
    }
    
    // Update storage indicator
    function updateStorageIndicator() {
      try {
        const data = JSON.stringify(tickets);
        const dataSize = new Blob([data]).size;
        const usedMB = dataSize / 1024 / 1024;
        const usedPercent = (usedMB / 5) * 100; // Assuming 5MB limit
        
        let indicator = document.getElementById('storageIndicator');
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.id = 'storageIndicator';
          indicator.className = 'storage-indicator';
          document.body.appendChild(indicator);
        }
        
        indicator.textContent = `${usedPercent.toFixed(0)}% storage used`;
        
        if (usedPercent > 80) {
          indicator.classList.add('storage-warning');
        } else {
          indicator.classList.remove('storage-warning');
        }
      } catch (error) {
        console.error('Error updating storage indicator:', error);
      }
    }
    
    // Show storage info
    function showStorageInfo() {
      try {
        const data = JSON.stringify(tickets);
        const dataSize = new Blob([data]).size;
        const usedMB = (dataSize / 1024 / 1024).toFixed(2);
        const quotaMB = (localStorage.remainingSpace || 5).toFixed(2); // Approximate
        const freeMB = (quotaMB - usedMB).toFixed(2);
        
        alert(`Storage Usage:\nUsed: ${usedMB} MB\nFree: ${freeMB} MB\nTotal Cases: ${tickets.length}`);
      } catch (error) {
        console.error('Error getting storage info:', error);
        alert('Error getting storage information');
      }
    }
    
    // Clean base64 images
    function cleanBase64Images() {
      let cleanedCount = 0;
      tickets = tickets.map(ticket => {
        if (ticket.evidence && ticket.evidence.startsWith('data:image')) {
          cleanedCount++;
          return { ...ticket, evidence: 'None' };
        }
        return ticket;
      });
      
      if (cleanedCount > 0) {
        if (save()) {
          renderAll();
          showNotification(`Cleaned ${cleanedCount} images. Storage freed.`, 'success');
        }
      } else {
        showNotification('No base64 images found to clean.', 'info');
      }
    }
    
    // Remove old cases
    function removeOldCases() {
      const monthsToKeep = 3; // Keep last 3 months
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - monthsToKeep);
      
      const originalCount = tickets.length;
      tickets = tickets.filter(ticket => {
        const ticketDate = new Date(ticket.orderDate || ticket.dateCreated || Date.now());
        return ticketDate > cutoffDate;
      });
      
      const removedCount = originalCount - tickets.length;
      
      if (removedCount > 0) {
        if (save()) {
          renderAll();
          showNotification(`Removed ${removedCount} old cases. Storage freed.`, 'success');
        }
      } else {
        showNotification('No old cases found to remove.', 'info');
      }
    }
    
    // Offer storage cleanup
    function offerStorageCleanup() {
      if (confirm('Storage is full. Would you like to clean up old cases or images?')) {
        // Show a modal with cleanup options
        const cleanupModal = new bootstrap.Modal(document.getElementById('cleanupModal'));
        cleanupModal.show();
      }
    }
    
    // ===== Commands tracking functions =====
    function addCommand(title, details = '') {
      const now = new Date();
      const command = {
        id: Date.now(),
        title,
        details,
        time: now.toLocaleTimeString()
      };
      
      commands.unshift(command);
      
      // Keep only last 50 commands to prevent memory issues
      if (commands.length > 50) {
        commands = commands.slice(0, 50);
      }
      
      updateCommandsDisplay();
    }
    
    function updateCommandsDisplay() {
      // Update fixed window (last 3 commands)
      const commandsList = document.getElementById('commandsList');
      const lastCommands = commands.slice(0, MAX_COMMANDS_VISIBLE);
      
      commandsList.innerHTML = lastCommands.map(cmd => `
        <div class="command-item">
          <div>${cmd.title}</div>
          <div class="command-time">${cmd.time}</div>
        </div>
      `).join('');
      
      // Update all commands list
      const allCommandsList = document.getElementById('allCommandsList');
      allCommandsList.innerHTML = commands.map(cmd => `
        <div class="command-item">
          <div class="command-header">
            <div class="command-title">${cmd.title}</div>
            <div class="command-time">${cmd.time}</div>
          </div>
          ${cmd.details ? `<div class="command-details">${cmd.details}</div>` : ''}
        </div>
      `).join('');
    }
    
    function clearCommands() {
      if (confirm('Clear all command history?')) {
        commands = [];
        updateCommandsDisplay();
        showNotification('Command history cleared', 'success');
      }
    }
    
    // ===== Populate branch selects =====
    function populateBranchFilters() {
      // branch select in filters and modal
      filterBranch.innerHTML = '<option value="">All Branches</option>';
      const fBranch = document.getElementById('f_branch');
      fBranch.innerHTML = '<option value="">Select Branch</option>';
      branchesList.forEach(b => {
        const opt1 = document.createElement('option'); opt1.value = b; opt1.textContent = b; filterBranch.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = b; opt2.textContent = b; fBranch.appendChild(opt2);
      });
    }
    
    // ===== Utility =====
    function save() {
      try {
        // Check storage quota before saving
        if (!checkStorageQuota()) {
          showNotification('Storage quota exceeded. Please clean up old cases or images.', 'error');
          offerStorageCleanup();
          return false;
        }
        
        localStorage.setItem('crispyTickets', JSON.stringify(tickets));
        console.log('Saved tickets:', tickets.length);
        return true;
      } catch (error) {
        console.error('Error saving tickets to localStorage:', error);
        
        // Handle specific quota exceeded error
        if (error.name === 'QuotaExceededError' || 
            error.message.includes('quota') || 
            error.message.includes('exceeded')) {
          showNotification('Storage full! Please clean up old cases or images.', 'error');
          offerStorageCleanup();
        } else {
          showNotification('Error saving data', 'error');
        }
        return false;
      }
    }
    
    function showNotification(msg, type = 'success') {
      notification.className = `notification ${type} show`;
      notification.textContent = msg;
      
      // Add magical animation
      notification.style.animation = 'magicalSlideIn 0.5s ease-out';
      
      setTimeout(() => {
        notification.style.animation = 'magicalSlideOut 0.5s ease-out';
        setTimeout(() => {
          notification.className = `notification ${type}`;
        }, 500);
      }, 3000);
    }
    
    function formatDateISO(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      return d.toLocaleString();
    }
    
    function updateSummaryDate() {
      const now = new Date();
      const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
      document.getElementById('summaryDate').textContent = now.toLocaleDateString('en-US', options);
    }
    
    // ===== Generate Short Link =====
    function generateShortLink() {
      const ticketId = Date.now().toString();
      const shortLink = `https://crispy.ch/t/${ticketId.slice(-6)}`;
      document.getElementById('f_shortLink').value = shortLink;
      showNotification('Short link generated', 'success');
    }
    
    // ===== Handle Image Upload =====
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        // Check file size (limit to 1MB)
        if (file.size > 1024 * 1024) {
          showNotification('Image size must be less than 1MB', 'error');
          return;
        }
        
        // Check storage before uploading
        if (!checkStorageQuota()) {
          showNotification('Not enough storage space. Please clean up first.', 'error');
          offerStorageCleanup();
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('imagePreview');
          preview.src = e.target.result;
          preview.style.display = 'block';
          
          // Store base64 data in a hidden field
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.id = 'f_evidenceBase64';
          hiddenInput.value = e.target.result;
          document.getElementById('ticketForm').appendChild(hiddenInput);
          
          showNotification('Image uploaded successfully', 'success');
        };
        reader.readAsDataURL(file);
      }
    }
    
    // ===== Show Daily Summary =====
    function showDailySummary() {
      const today = new Date().toISOString().split('T')[0];
      const todayTickets = tickets.filter(t => t.orderDate.startsWith(today));
      
      // Group by branch
      const branchSummary = {};
      todayTickets.forEach(ticket => {
        if (!branchSummary[ticket.branch]) {
          branchSummary[ticket.branch] = {
            totalCases: 0,
            totalCompensation: 0,
            totalRefunded: 0,
            cases: []
          };
        }
        branchSummary[ticket.branch].totalCases++;
        branchSummary[ticket.branch].totalCompensation += ticket.compensation || 0;
        branchSummary[ticket.branch].totalRefunded += ticket.refundedAmount || 0;
        branchSummary[ticket.branch].cases.push(ticket);
      });
      
      // Generate HTML for daily summary
      let html = '';
      Object.keys(branchSummary).forEach(branch => {
        const summary = branchSummary[branch];
        html += `
          <div class="daily-branch-item">
            <div class="daily-branch-header">
              <div class="daily-branch-name">${branch}</div>
              <div class="daily-branch-stats">
                <div class="daily-stat">
                  <div class="daily-stat-value">${summary.totalCases}</div>
                  <div class="daily-stat-label">Cases</div>
                </div>
                <div class="daily-stat">
                  <div class="daily-stat-value">${summary.totalCompensation.toFixed(2)}</div>
                  <div class="daily-stat-label">Compensation</div>
                </div>
                <div class="daily-stat">
                  <div class="daily-stat-value">${summary.totalRefunded.toFixed(2)}</div>
                  <div class="daily-stat-label">Refunded</div>
                </div>
              </div>
            </div>
            <div class="daily-cases">
              ${summary.cases.map(ticket => `
                <div class="case-item ${ticket.status === 'Closed' ? 'recovered' : 'pending'}">
                  <div class="case-info">
                    <div class="case-order">${ticket.orderId}</div>
                    <div class="case-platform">${ticket.platform}</div>
                  </div>
                  <div class="case-amount">${ticket.compensation} AED</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      document.getElementById('dailySummaryContent').innerHTML = html || '<p class="text-center text-muted">No cases found for today</p>';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('dailySummaryModal'));
      modal.show();
    }
    
    // ===== Export Functions =====
    function exportExcel() {
      const ws = XLSX.utils.json_to_sheet(tickets.map(ticket => ({
        'Order ID': ticket.orderId,
        'Order Date': ticket.orderDate,
        'Branch': ticket.branch,
        'Platform': ticket.platform,
        'Case': ticket.issue,
        'Original Amount': ticket.originalAmount,
        'Compensation': ticket.compensation,
        'Refunded Amount': ticket.refundedAmount,
        'Status': ticket.status,
        'Date Created': ticket.dateCreated
      })));
      
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Compensation Cases');
      XLSX.writeFile(wb, 'compensation_cases.xlsx');
      
      showNotification('Data exported to Excel successfully', 'success');
    }
    
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(20);
      doc.text('Compensation Cases Report', 105, 20, { align: 'center' });
      
      // Add date
      doc.setFontSize(12);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
      
      // Add table headers
      let yPosition = 50;
      doc.setFontSize(10);
      doc.text('Order ID', 20, yPosition);
      doc.text('Branch', 60, yPosition);
      doc.text('Platform', 100, yPosition);
      doc.text('Status', 140, yPosition);
      doc.text('Amount', 170, yPosition);
      
      // Add table data
      yPosition += 10;
      tickets.forEach(ticket => {
        if (yPosition > 270) {
          doc.addPage();
          yPosition = 20;
        }
        
        doc.text(ticket.orderId, 20, yPosition);
        doc.text(ticket.branch, 60, yPosition);
        doc.text(ticket.platform, 100, yPosition);
        doc.text(ticket.status, 140, yPosition);
        doc.text(ticket.compensation.toString(), 170, yPosition);
        
        yPosition += 10;
      });
      
      doc.save('compensation_cases.pdf');
      showNotification('Data exported to PDF successfully', 'success');
    }
    
    function exportDashboardSummary() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Add title
      doc.setFontSize(20);
      doc.text('Dashboard Summary Report', 105, 20, { align: 'center' });
      
      // Add date
      doc.setFontSize(12);
      doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
      
      // Add summary data
      const summary = [
        ['Total Cases', tickets.length],
        ['Open Cases', tickets.filter(t => t.status === 'Open').length],
        ['Closed Cases', tickets.filter(t => t.status === 'Closed').length],
        ['Total Compensation', tickets.reduce((sum, t) => sum + t.compensation, 0).toFixed(2)],
        ['Total Refunded', tickets.reduce((sum, t) => sum + t.refundedAmount, 0).toFixed(2)]
      ];
      
      let yPosition = 50;
      doc.setFontSize(12);
      summary.forEach(([label, value]) => {
        doc.text(`${label}: ${value}`, 20, yPosition);
        yPosition += 15;
      });
      
      doc.save('dashboard_summary.pdf');
      showNotification('Dashboard summary exported successfully', 'success');
    }
    
    function exportUsabilityLog() {
      const logData = {
        commands: commands,
        timestamp: new Date().toISOString(),
        ticketCount: tickets.length,
        browserInfo: navigator.userAgent,
        screenSize: `${window.screen.width}x${window.screen.height}`,
        windowSize: `${window.innerWidth}x${window.innerHeight}`
      };
      
      const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `usability_log_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      showNotification('Usability log exported successfully', 'success');
    }
    
    // ===== Print Functions =====
    function printReport() {
      window.print();
    }
    
    // ===== Reset Functions =====
    function resetAll() {
      if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
        tickets = [];
        commands = [];
        localStorage.clear();
        
        populateBranchFilters();
        renderAll();
        updateCommandsDisplay();
        updateStorageIndicator();
        
        showNotification('All data has been reset', 'success');
      }
    }
    
    // ===== Modal Functions =====
    function openAddModal() {
      document.getElementById('ticketForm').reset();
      document.getElementById('editingId').value = '';
      document.getElementById('modalTitle').textContent = 'Add Magical Compensation Case';
      document.getElementById('imagePreview').style.display = 'none';
      
      const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
      modal.show();
      
      addCommand('Opened add case modal');
    }
    
    function openRejectionModal() {
      // Populate rejection cases dropdown
      const rejectionCases = tickets.filter(t => t.status === 'Open' || t.status === 'Sent');
      const caseSelect = document.getElementById('rejectionCase');
      caseSelect.innerHTML = '<option value="">Select Case</option>';
      
      rejectionCases.forEach(ticket => {
        const option = document.createElement('option');
        option.value = ticket.id;
        option.textContent = `${ticket.orderId} - ${ticket.branch}`;
        caseSelect.appendChild(option);
      });
      
      const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));
      modal.show();
      
      addCommand('Opened rejection modal');
    }
    
    function openRestaurantFaultModal() {
      // Populate restaurant fault cases dropdown
      const faultCases = tickets.filter(t => t.status === 'Open' || t.status === 'Sent');
      const caseSelect = document.getElementById('faultCase');
      caseSelect.innerHTML = '<option value="">Select Case</option>';
      
      faultCases.forEach(ticket => {
        const option = document.createElement('option');
        option.value = ticket.id;
        option.textContent = `${ticket.orderId} - ${ticket.branch}`;
        caseSelect.appendChild(option);
      });
      
      const modal = new bootstrap.Modal(document.getElementById('restaurantFaultModal'));
      modal.show();
      
      addCommand('Opened restaurant fault modal');
    }
    
    // ===== Form Submission =====
    document.getElementById('ticketForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const ticket = {
        id: document.getElementById('editingId').value || Date.now().toString(),
        orderId: document.getElementById('f_orderId').value,
        orderDate: document.getElementById('f_orderDate').value,
        branch: document.getElementById('f_branch').value,
        platform: document.getElementById('f_platform').value,
        issue: document.getElementById('f_issue').value,
        originalAmount: parseFloat(document.getElementById('f_originalAmount').value),
        compensation: parseFloat(document.getElementById('f_compensation').value),
        refundedAmount: parseFloat(document.getElementById('f_refundedAmount').value) || 0,
        isRefunded: document.getElementById('f_isRefunded').checked,
        refundDate: document.getElementById('f_refundDate').value,
        evidence: document.getElementById('f_noEvidence').checked ? 'None' : (document.getElementById('f_evidenceBase64')?.value || 'None'),
        shortLink: document.getElementById('f_shortLink').value,
        status: 'Open',
        dateCreated: new Date().toISOString()
      };
      
      // Check for duplicate order ID
      const existingTicket = tickets.find(t => t.orderId === ticket.orderId && t.id !== ticket.id);
      if (existingTicket) {
        showNotification('Duplicate Order ID detected', 'error');
        return;
      }
      
      // Save or update ticket
      if (ticket.id && tickets.find(t => t.id === ticket.id)) {
        // Update existing ticket
        const index = tickets.findIndex(t => t.id === ticket.id);
        tickets[index] = ticket;
        showNotification('Case updated successfully', 'success');
        addCommand(`Updated case ${ticket.orderId}`);
      } else {
        // Add new ticket
        tickets.push(ticket);
        showNotification('Case added successfully', 'success');
        addCommand(`Added new case ${ticket.orderId}`);
      }
      
      // Save data
      if (save()) {
        // Update UI
        renderAll();
        updateStorageIndicator();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
        modal.hide();
      }
    });
    
    // ===== Rejection Form Submission =====
    document.getElementById('rejectionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const ticketId = document.getElementById('rejectionCase').value;
      const reason = document.getElementById('rejectionReason').value;
      const notes = document.getElementById('rejectionNotes').value;
      const sendEmail = document.getElementById('sendEmail').checked;
      const sendWhatsApp = document.getElementById('sendWhatsApp').checked;
      
      // Update ticket status
      const ticket = tickets.find(t => t.id === ticketId);
      if (ticket) {
        ticket.status = 'Rejected';
        ticket.rejectionReason = reason;
        ticket.rejectionNotes = notes;
        ticket.rejectionDate = new Date().toISOString();
        
        if (save()) {
          renderAll();
          showNotification('Case rejected successfully', 'success');
          addCommand(`Rejected case ${ticket.orderId}`);
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('rejectionModal'));
          modal.hide();
        }
      }
    });
    
    // ===== Restaurant Fault Form Submission =====
    document.getElementById('restaurantFaultForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const ticketId = document.getElementById('faultCase').value;
      const compensation = parseFloat(document.getElementById('faultCompensation').value);
      const notes = document.getElementById('faultNotes').value;
      const sendEmail = document.getElementById('faultSendEmail').checked;
      const sendWhatsApp = document.getElementById('faultSendWhatsApp').checked;
      
      // Update ticket status
      const ticket = tickets.find(t => t.id === ticketId);
      if (ticket) {
        ticket.status = 'Restaurant Fault';
        ticket.compensation = compensation;
        ticket.restaurantFaultNotes = notes;
        ticket.restaurantFaultDate = new Date().toISOString();
        
        if (save()) {
          renderAll();
          showNotification('Restaurant fault case updated successfully', 'success');
          addCommand(`Updated restaurant fault case ${ticket.orderId}`);
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('restaurantFaultModal'));
          modal.hide();
        }
      }
    });
    
    // ===== Search and Filter Functions =====
    function filterTickets() {
      const searchTerm = searchInput.value.toLowerCase();
      const branchFilter = filterBranch.value;
      const platformFilter = filterPlatform.value;
      const statusFilter = filterStatus.value;
      
      const rows = ticketsTableBody.querySelectorAll('tr');
      
      rows.forEach(row => {
        // Skip empty state row
        if (row.querySelector('.empty-state')) return;
        
        const orderId = row.cells[0].textContent.toLowerCase();
        const branch = row.cells[2].textContent.toLowerCase();
        const platform = row.cells[3].textContent.toLowerCase();
        const issue = row.cells[4].textContent.toLowerCase();
        const status = row.cells[6].textContent.toLowerCase();
        
        const matchesSearch = orderId.includes(searchTerm) || branch.includes(searchTerm) || issue.includes(searchTerm);
        const matchesBranch = !branchFilter || branch === branchFilter.toLowerCase();
        const matchesPlatform = !platformFilter || platform === platformFilter.toLowerCase();
        const matchesStatus = !statusFilter || status === statusFilter.toLowerCase();
        
        if (matchesSearch && matchesBranch && matchesPlatform && matchesStatus) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
    
    // ===== Event Listeners =====
    function setupListeners() {
      // Search and filter inputs
      searchInput.addEventListener('input', filterTickets);
      filterBranch.addEventListener('change', filterTickets);
      filterPlatform.addEventListener('change', filterTickets);
      filterStatus.addEventListener('change', filterTickets);
      
      // Dock toggle
      dockToggle.addEventListener('click', function() {
        dockPanel.classList.toggle('show');
        addCommand(dockPanel.classList.contains('show') ? 'Opened dock panel' : 'Closed dock panel');
      });
      
      // Back to top button
      window.addEventListener('scroll', function() {
        const backToTopButton = document.getElementById('backToTop');
        if (window.pageYOffset > 300) {
          backToTopButton.classList.add('show');
        } else {
          backToTopButton.classList.remove('show');
        }
      });
      
      // Back to top function
      window.scrollToTop = function() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      };
      
      // Issue expand button
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('issue-expand')) {
          const issueText = e.target.parentElement.querySelector('.ticket-issue');
          if (issueText.textContent.endsWith('...')) {
            issueText.textContent = issueText.title;
            e.target.textContent = 'less';
          } else {
            issueText.textContent = issueText.title.substring(0, 30) + '...';
            e.target.textContent = 'more';
          }
        }
      });
    }
    
    // ===== Render Functions =====
    function renderAll() {
      updateStats();
      updateSummarySection();
      updatePlatformCards();
      updateCharts();
      updateBranchAnalysis();
      updateCompensationAnalysis();
      updateRejectionAnalysis();
      updateRestaurantFaultAnalysis();
      updateRefundAnalysis();
      renderTicketsTable();
      updateStorageIndicator();
    }
    
    function updateStats() {
      // Total tickets
      document.getElementById('totalTickets').textContent = tickets.length;
      
      // Status counts
      const openTickets = tickets.filter(t => t.status === 'Open').length;
      const sentTickets = tickets.filter(t => t.status === 'Sent').length;
      const closedTickets = tickets.filter(t => t.status === 'Closed').length;
      const rejectedTickets = tickets.filter(t => t.status === 'Rejected').length;
      const restaurantFaultCases = tickets.filter(t => t.status === 'Restaurant Fault').length;
      
      document.getElementById('openTickets').textContent = openTickets;
      document.getElementById('sentTickets').textContent = sentTickets;
      document.getElementById('closedTickets').textContent = closedTickets;
      document.getElementById('rejectedTickets').textContent = rejectedTickets;
      document.getElementById('restaurantFaultCases').textContent = restaurantFaultCases;
      
      // Resolved disputes (closed tickets with refunded amount)
      const resolvedDisputes = tickets.filter(t => t.status === 'Closed' && t.refundedAmount > 0).length;
      document.getElementById('resolvedDisputes').textContent = resolvedDisputes;
      
      // Active compensations (open or sent tickets)
      const activeCompensations = tickets.filter(t => t.status === 'Open' || t.status === 'Sent').length;
      document.getElementById('activeCompensations').textContent = activeCompensations;
      
      // Total compensation amount
      const totalCompensation = tickets.reduce((sum, t) => sum + (t.compensation || 0), 0);
      document.getElementById('totalCompensationAmount').textContent = totalCompensation.toFixed(2);
    }
    
    function updateSummarySection() {
      // Financial Overview
      const totalOriginalAmount = tickets.reduce((sum, t) => sum + (t.originalAmount || 0), 0);
      const totalCompensation = tickets.reduce((sum, t) => sum + (t.compensation || 0), 0);
      const totalRefunded = tickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
      const netCompensation = totalCompensation - totalRefunded;
      
      document.getElementById('totalOriginalAmount').textContent = totalOriginalAmount.toFixed(2);
      document.getElementById('totalCompensation').textContent = totalCompensation.toFixed(2);
      document.getElementById('totalRefunded').textContent = totalRefunded.toFixed(2);
      document.getElementById('netCompensation').textContent = netCompensation.toFixed(2);
      
      // Platform Performance
      const noonTickets = tickets.filter(t => t.platform === 'Noon');
      const careemTickets = tickets.filter(t => t.platform === 'Careem');
      const noonRefunded = noonTickets.filter(t => t.refundedAmount > 0).length;
      const careemRefunded = careemTickets.filter(t => t.refundedAmount > 0).length;
      
      document.getElementById('noonTickets').textContent = noonTickets.length;
      document.getElementById('careemTickets').textContent = careemTickets.length;
      document.getElementById('noonRefunded').textContent = noonRefunded;
      document.getElementById('careemRefunded').textContent = careemRefunded;
      
      // Branch Performance
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranch = Object.keys(branchCounts).reduce((a, b) => 
        branchCounts[a] > branchCounts[b] ? a : b, '-');
      
      document.getElementById('topBranch').textContent = topBranch;
      document.getElementById('topBranchCases').textContent = 
        topBranch !== '-' ? `${branchCounts[topBranch]} cases` : '0 cases';
      
      // Top case type
      const caseTypes = {};
      tickets.forEach(t => {
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCase = Object.keys(caseTypes).reduce((a, b) => 
        caseTypes[a] > caseTypes[b] ? a : b, '-');
      
      document.getElementById('topCase').textContent = topCase;
      document.getElementById('topCaseCount').textContent = 
        topCase !== '-' ? `${caseTypes[topCase]} cases` : '0 cases';
      
      // Case rate
      const caseRate = tickets.length > 0 ? 
        ((tickets.length / (tickets.length * 10)) * 100).toFixed(1) : 0;
      document.getElementById('caseRate').textContent = `${caseRate}%`;
      
      // Average original amount
      const avgOriginalAmount = tickets.length > 0 ? 
        (totalOriginalAmount / tickets.length).toFixed(2) : 0;
      document.getElementById('avgOriginalAmount').textContent = avgOriginalAmount;
      
      // Update charts
      updateSummaryCharts();
    }
    
    function updateSummaryCharts() {
      // Amount Chart
      const amountCtx = document.getElementById('amountChart').getContext('2d');
      if (amountChart) amountChart.destroy();
      
      amountChart = new Chart(amountCtx, {
        type: 'bar',
        data: {
          labels: ['Original', 'Compensation', 'Refunded', 'Net'],
          datasets: [{
            data: [
              tickets.reduce((sum, t) => sum + (t.originalAmount || 0), 0),
              tickets.reduce((sum, t) => sum + (t.compensation || 0), 0),
              tickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0),
              tickets.reduce((sum, t) => sum + ((t.compensation || 0) - (t.refundedAmount || 0)), 0)
            ],
            backgroundColor: [
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 99, 132, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Status Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Open', 'Sent', 'Closed', 'Rejected', 'Restaurant Fault'],
          datasets: [{
            data: [
              tickets.filter(t => t.status === 'Open').length,
              tickets.filter(t => t.status === 'Sent').length,
              tickets.filter(t => t.status === 'Closed').length,
              tickets.filter(t => t.status === 'Rejected').length,
              tickets.filter(t => t.status === 'Restaurant Fault').length
            ],
            backgroundColor: [
              'rgba(13, 110, 253, 0.5)',
              'rgba(255, 193, 7, 0.5)',
              'rgba(25, 135, 84, 0.5)',
              'rgba(220, 53, 69, 0.5)',
              'rgba(255, 193, 7, 0.5)'
            ],
            borderColor: [
              'rgba(13, 110, 253, 1)',
              'rgba(255, 193, 7, 1)',
              'rgba(25, 135, 84, 1)',
              'rgba(220, 53, 69, 1)',
              'rgba(255, 193, 7, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Platform Tickets Chart
      const platformTicketsCtx = document.getElementById('platformTicketsChart').getContext('2d');
      if (platformTicketsChart) platformTicketsChart.destroy();
      
      platformTicketsChart = new Chart(platformTicketsCtx, {
        type: 'bar',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            label: 'Cases',
            data: [
              tickets.filter(t => t.platform === 'Noon').length,
              tickets.filter(t => t.platform === 'Careem').length
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Platform Compensation Chart
      const platformCompensationCtx = document.getElementById('platformCompensationChart').getContext('2d');
      if (platformCompensationChart) platformCompensationChart.destroy();
      
      platformCompensationChart = new Chart(platformCompensationCtx, {
        type: 'bar',
        data: {
          labels: ['Noon', 'Careem'],
          datasets: [{
            label: 'Refunded',
            data: [
              tickets.filter(t => t.platform === 'Noon' && t.refundedAmount > 0).length,
              tickets.filter(t => t.platform === 'Careem' && t.refundedAmount > 0).length
            ],
            backgroundColor: [
              'rgba(255, 112, 67, 0.5)',
              'rgba(126, 87, 194, 0.5)'
            ],
            borderColor: [
              'rgba(255, 112, 67, 1)',
              'rgba(126, 87, 194, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Branch Cases Chart
      const branchCasesCtx = document.getElementById('branchCasesChart').getContext('2d');
      if (branchCasesChart) branchCasesChart.destroy();
      
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranches = Object.keys(branchCounts)
        .sort((a, b) => branchCounts[b] - branchCounts[a])
        .slice(0, 5);
      
      branchCasesChart = new Chart(branchCasesCtx, {
        type: 'bar',
        data: {
          labels: topBranches,
          datasets: [{
            label: 'Cases',
            data: topBranches.map(branch => branchCounts[branch]),
            backgroundColor: 'rgba(211, 47, 47, 0.5)',
            borderColor: 'rgba(211, 47, 47, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Case Types Chart
      const caseTypesCtx = document.getElementById('caseTypesChart').getContext('2d');
      if (caseTypesChart) caseTypesChart.destroy();
      
      const caseTypes = {};
      tickets.forEach(t => {
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCaseTypes = Object.keys(caseTypes)
        .sort((a, b) => caseTypes[b] - caseTypes[a])
        .slice(0, 5);
      
      caseTypesChart = new Chart(caseTypesCtx, {
        type: 'pie',
        data: {
          labels: topCaseTypes,
          datasets: [{
            data: topCaseTypes.map(caseType => caseTypes[caseType]),
            backgroundColor: [
              'rgba(255, 99, 132, 0.5)',
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 206, 86, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    }
    
    function updatePlatformCards() {
      const noonCount = tickets.filter(t => t.platform === 'Noon').length;
      const careemCount = tickets.filter(t => t.platform === 'Careem').length;
      const total = tickets.length;
      
      const noonPercentage = total > 0 ? ((noonCount / total) * 100).toFixed(1) : 0;
      const careemPercentage = total > 0 ? ((careemCount / total) * 100).toFixed(1) : 0;
      
      document.getElementById('noonCount').textContent = noonCount;
      document.getElementById('careemCount').textContent = careemCount;
      document.getElementById('noonPercentage').textContent = `${noonPercentage}%`;
      document.getElementById('careemPercentage').textContent = `${careemPercentage}%`;
    }
    
    function updateCharts() {
      // Branch Chart
      const branchCtx = document.getElementById('branchChart').getContext('2d');
      if (branchChart) branchChart.destroy();
      
      const branchCounts = {};
      tickets.forEach(t => {
        branchCounts[t.branch] = (branchCounts[t.branch] || 0) + 1;
      });
      
      const topBranches = Object.keys(branchCounts)
        .sort((a, b) => branchCounts[b] - branchCounts[a])
        .slice(0, 5);
      
      branchChart = new Chart(branchCtx, {
        type: 'bar',
        data: {
          labels: topBranches,
          datasets: [{
            label: 'Cases',
            data: topBranches.map(branch => branchCounts[branch]),
            backgroundColor: 'rgba(211, 47, 47, 0.5)',
            borderColor: 'rgba(211, 47, 47, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Case Chart
      const caseCtx = document.getElementById('caseChart').getContext('2d');
      if (caseChart) caseChart.destroy();
      
      const caseTypes = {};
      tickets.forEach(t => {
        const caseType = t.issue.split(' ')[0] || 'Other';
        caseTypes[caseType] = (caseTypes[caseType] || 0) + 1;
      });
      
      const topCaseTypes = Object.keys(caseTypes)
        .sort((a, b) => caseTypes[b] - caseTypes[a])
        .slice(0, 5);
      
      caseChart = new Chart(caseCtx, {
        type: 'doughnut',
        data: {
          labels: topCaseTypes,
          datasets: [{
            data: topCaseTypes.map(caseType => caseTypes[caseType]),
            backgroundColor: [
              'rgba(255, 99, 132, 0.5)',
              'rgba(54, 162, 235, 0.5)',
              'rgba(255, 206, 86, 0.5)',
              'rgba(75, 192, 192, 0.5)',
              'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Update labels
      document.getElementById('topBranchLabel').textContent = 
        topBranches.length > 0 ? `Top: ${topBranches[0]} (${branchCounts[topBranches[0]]} cases)` : 'No data';
      
      document.getElementById('topCaseLabel').textContent = 
        topCaseTypes.length > 0 ? `Top: ${topCaseTypes[0]} (${caseTypes[topCaseTypes[0]]} cases)` : 'No data';
    }
    
    function updateBranchAnalysis() {
      const container = document.getElementById('branchAnalysisContainer');
      container.innerHTML = '';
      
      // Group tickets by branch
      const branchTickets = {};
      tickets.forEach(ticket => {
        if (!branchTickets[ticket.branch]) {
          branchTickets[ticket.branch] = [];
        }
        branchTickets[ticket.branch].push(ticket);
      });
      
      // Create branch analysis grid
      const grid = document.createElement('div');
      grid.className = 'branch-analysis-grid';
      
      // Create a card for each branch
      Object.keys(branchTickets).forEach(branch => {
        const branchCard = document.createElement('div');
        branchCard.className = 'branch-card';
        
        const branchHeader = document.createElement('h6');
        branchHeader.textContent = branch;
        branchCard.appendChild(branchHeader);
        
        // Create branch stats
        const stats = document.createElement('div');
        stats.className = 'branch-stats';
        
        const openCount = branchTickets[branch].filter(t => t.status === 'Open').length;
        const sentCount = branchTickets[branch].filter(t => t.status === 'Sent').length;
        const closedCount = branchTickets[branch].filter(t => t.status === 'Closed').length;
        const rejectedCount = branchTickets[branch].filter(t => t.status === 'Rejected').length;
        
        // Open stat
        const openStat = document.createElement('div');
        openStat.className = 'branch-stat-item';
        const openValue = document.createElement('div');
        openValue.className = 'branch-stat-value';
        openValue.textContent = openCount;
        openValue.style.color = '#0d6efd';
        const openLabel = document.createElement('div');
        openLabel.className = 'branch-stat-label';
        openLabel.textContent = 'Open';
        openStat.appendChild(openValue);
        openStat.appendChild(openLabel);
        stats.appendChild(openStat);
        
        // Sent stat
        const sentStat = document.createElement('div');
        sentStat.className = 'branch-stat-item';
        const sentValue = document.createElement('div');
        sentValue.className = 'branch-stat-value';
        sentValue.textContent = sentCount;
        sentValue.style.color = '#ffc107';
        const sentLabel = document.createElement('div');
        sentLabel.className = 'branch-stat-label';
        sentLabel.textContent = 'Sent';
        sentStat.appendChild(sentValue);
        sentStat.appendChild(sentLabel);
        stats.appendChild(sentStat);
        
        // Closed stat
        const closedStat = document.createElement('div');
        closedStat.className = 'branch-stat-item';
        const closedValue = document.createElement('div');
        closedValue.className = 'branch-stat-value';
        closedValue.textContent = closedCount;
        closedValue.style.color = '#198754';
        const closedLabel = document.createElement('div');
        closedLabel.className = 'branch-stat-label';
        closedLabel.textContent = 'Closed';
        closedStat.appendChild(closedValue);
        closedStat.appendChild(closedLabel);
        stats.appendChild(closedStat);
        
        // Rejected stat
        const rejectedStat = document.createElement('div');
        rejectedStat.className = 'branch-stat-item';
        const rejectedValue = document.createElement('div');
        rejectedValue.className = 'branch-stat-value';
        rejectedValue.textContent = rejectedCount;
        rejectedValue.style.color = '#dc3545';
        const rejectedLabel = document.createElement('div');
        rejectedLabel.className = 'branch-stat-label';
        rejectedLabel.textContent = 'Rejected';
        rejectedStat.appendChild(rejectedValue);
        rejectedStat.appendChild(rejectedLabel);
        stats.appendChild(rejectedStat);
        
        branchCard.appendChild(stats);
        
        // Create case reasons
        const reasons = document.createElement('div');
        reasons.className = 'case-reasons';
        
        const reasonsTitle = document.createElement('h6');
        reasonsTitle.textContent = 'Top Case Reasons';
        reasons.appendChild(reasonsTitle);
        
        // Count case reasons
        const reasonCounts = {};
        branchTickets[branch].forEach(ticket => {
          const reason = ticket.issue.split(' ')[0] || 'Other';
          reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
        });
        
        // Sort reasons by count
        const sortedReasons = Object.keys(reasonCounts)
          .sort((a, b) => reasonCounts[b] - reasonCounts[a])
          .slice(0, 3);
        
        // Create reason items
        sortedReasons.forEach(reason => {
          const reasonItem = document.createElement('div');
          reasonItem.className = 'case-reason-item';
          
          const reasonInfo = document.createElement('div');
          reasonInfo.className = 'case-reason-info';
          
          const reasonName = document.createElement('div');
          reasonName.className = 'case-reason-name';
          reasonName.textContent = reason;
          
          const reasonCount = document.createElement('div');
          reasonCount.className = 'case-reason-count';
          reasonCount.textContent = `${reasonCounts[reason]} cases`;
          
          reasonInfo.appendChild(reasonName);
          reasonInfo.appendChild(reasonCount);
          
          const reasonBar = document.createElement('div');
          reasonBar.className = 'case-reason-bar';
          
          const reasonProgress = document.createElement('div');
          reasonProgress.className = 'case-reason-progress';
          const percentage = (reasonCounts[reason] / branchTickets[branch].length) * 100;
          reasonProgress.style.width = `${percentage}%`;
          
          reasonBar.appendChild(reasonProgress);
          
          reasonItem.appendChild(reasonInfo);
          reasonItem.appendChild(reasonBar);
          
          reasons.appendChild(reasonItem);
        });
        
        branchCard.appendChild(reasons);
        grid.appendChild(branchCard);
      });
      
      container.appendChild(grid);
      
      // Update case analysis badge
      const openTickets = tickets.filter(t => t.status === 'Open').length;
      const totalTickets = tickets.length;
      const percentage = totalTickets > 0 ? (openTickets / totalTickets) * 100 : 0;
      
      const badge = document.getElementById('caseAnalysisBadge');
      badge.textContent = `${percentage.toFixed(1)}% Open Cases`;
      
      if (percentage > 30) {
        badge.className = 'case-badge badge-high';
      } else if (percentage > 15) {
        badge.className = 'case-badge badge-medium';
      } else {
        badge.className = 'case-badge badge-low';
      }
    }
    
    function updateCompensationAnalysis() {
      const container = document.getElementById('compensationAnalysisContainer');
      container.innerHTML = '';
      
      // Group tickets by compensation type
      const compensationTypes = {};
      tickets.forEach(ticket => {
        if (ticket.compensation > 0) {
          const compType = ticket.issue.split(' ')[0] || 'Other';
          if (!compensationTypes[compType]) {
            compensationTypes[compType] = {
              count: 0,
              totalAmount: 0,
              refundedAmount: 0
            };
          }
          compensationTypes[compType].count++;
          compensationTypes[compType].totalAmount += ticket.compensation;
          compensationTypes[compType].refundedAmount += ticket.refundedAmount || 0;
        }
      });
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'compensation-analysis-grid';
      
      // Create a card for each compensation type
      Object.keys(compensationTypes).forEach(type => {
        const card = document.createElement('div');
        card.className = 'compensation-card';
        
        const header = document.createElement('h6');
        header.textContent = type;
        card.appendChild(header);
        
        // Create stats
        const stats = document.createElement('div');
        stats.className = 'compensation-stats';
        
        // Count stat
        const countStat = document.createElement('div');
        countStat.className = 'stat-item';
        const countValue = document.createElement('div');
        countValue.className = 'stat-value';
        countValue.textContent = compensationTypes[type].count;
        const countLabel = document.createElement('div');
        countLabel.className = 'stat-label';
        countLabel.textContent = 'Cases';
        countStat.appendChild(countValue);
        countStat.appendChild(countLabel);
        stats.appendChild(countStat);
        
        // Total amount stat
        const amountStat = document.createElement('div');
        amountStat.className = 'stat-item';
        const amountValue = document.createElement('div');
        amountValue.className = 'stat-value';
        amountValue.textContent = compensationTypes[type].totalAmount.toFixed(2);
        const amountLabel = document.createElement('div');
        amountLabel.className = 'stat-label';
        amountLabel.textContent = 'Total Amount';
        amountStat.appendChild(amountValue);
        amountStat.appendChild(amountLabel);
        stats.appendChild(amountStat);
        
        // Refunded amount stat
        const refundedStat = document.createElement('div');
        refundedStat.className = 'stat-item';
        const refundedValue = document.createElement('div');
        refundedValue.className = 'stat-value';
        refundedValue.textContent = compensationTypes[type].refundedAmount.toFixed(2);
        const refundedLabel = document.createElement('div');
        refundedLabel.className = 'stat-label';
        refundedLabel.textContent = 'Refunded';
        refundedStat.appendChild(refundedValue);
        refundedStat.appendChild(refundedLabel);
        stats.appendChild(refundedStat);
        
        // Refund rate stat
        const rateStat = document.createElement('div');
        rateStat.className = 'stat-item';
        const rateValue = document.createElement('div');
        rateValue.className = 'stat-value';
        const rate = compensationTypes[type].totalAmount > 0 ? 
          ((compensationTypes[type].refundedAmount / compensationTypes[type].totalAmount) * 100).toFixed(1) : 0;
        rateValue.textContent = `${rate}%`;
        const rateLabel = document.createElement('div');
        rateLabel.className = 'stat-label';
        rateLabel.textContent = 'Refund Rate';
        rateStat.appendChild(rateValue);
        rateStat.appendChild(rateLabel);
        stats.appendChild(rateStat);
        
        card.appendChild(stats);
        grid.appendChild(card);
      });
      
      container.appendChild(grid);
    }
    
    function updateRejectionAnalysis() {
      const container = document.getElementById('rejectionAnalysisContainer');
      container.innerHTML = '';
      
      // Get rejected tickets
      const rejectedTickets = tickets.filter(t => t.status === 'Rejected');
      
      if (rejectedTickets.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No rejected cases found</p>';
        return;
      }
      
      // Group rejected tickets by branch
      const branchRejections = {};
      rejectedTickets.forEach(ticket => {
        if (!branchRejections[ticket.branch]) {
          branchRejections[ticket.branch] = {
            count: 0,
            totalAmount: 0
          };
        }
        branchRejections[ticket.branch].count++;
        branchRejections[ticket.branch].totalAmount += ticket.compensation || 0;
      });
      
      // Group rejected tickets by platform
      const platformRejections = {};
      rejectedTickets.forEach(ticket => {
        if (!platformRejections[ticket.platform]) {
          platformRejections[ticket.platform] = {
            count: 0,
            totalAmount: 0
          };
        }
        platformRejections[ticket.platform].count++;
        platformRejections[ticket.platform].totalAmount += ticket.compensation || 0;
      });
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'rejection-analysis-grid';
      
      // Create a card for branch rejections
      const branchCard = document.createElement('div');
      branchCard.className = 'rejection-card';
      
      const branchHeader = document.createElement('h6');
      branchHeader.textContent = 'Rejections by Branch';
      branchCard.appendChild(branchHeader);
      
      // Create stats
      const branchStats = document.createElement('div');
      branchStats.className = 'rejection-stats';
      
      // Total rejections stat
      const totalRejectionsStat = document.createElement('div');
      totalRejectionsStat.className = 'rejection-metric-item';
      const totalRejectionsValue = document.createElement('div');
      totalRejectionsValue.className = 'rejection-metric-value';
      totalRejectionsValue.textContent = rejectedTickets.length;
      const totalRejectionsLabel = document.createElement('div');
      totalRejectionsLabel.className = 'rejection-metric-label';
      totalRejectionsLabel.textContent = 'Total Rejections';
      totalRejectionsStat.appendChild(totalRejectionsValue);
      totalRejectionsStat.appendChild(totalRejectionsLabel);
      branchStats.appendChild(totalRejectionsStat);
      
      // Total rejected amount stat
      const totalRejectedAmountStat = document.createElement('div');
      totalRejectedAmountStat.className = 'rejection-metric-item';
      const totalRejectedAmountValue = document.createElement('div');
      totalRejectedAmountValue.className = 'rejection-metric-value';
      const totalRejectedAmount = rejectedTickets.reduce((sum, t) => sum + (t.compensation || 0), 0);
      totalRejectedAmountValue.textContent = totalRejectedAmount.toFixed(2);
      const totalRejectedAmountLabel = document.createElement('div');
      totalRejectedAmountLabel.className = 'rejection-metric-label';
      totalRejectedAmountLabel.textContent = 'Total Amount';
      totalRejectedAmountStat.appendChild(totalRejectedAmountValue);
      totalRejectedAmountStat.appendChild(totalRejectedAmountLabel);
      branchStats.appendChild(totalRejectedAmountStat);
      
      // Rejection rate stat
      const rejectionRateStat = document.createElement('div');
      rejectionRateStat.className = 'rejection-metric-item';
      const rejectionRateValue = document.createElement('div');
      rejectionRateValue.className = 'rejection-metric-value';
      const rejectionRate = tickets.length > 0 ? ((rejectedTickets.length / tickets.length) * 100).toFixed(1) : 0;
      rejectionRateValue.textContent = `${rejectionRate}%`;
      const rejectionRateLabel = document.createElement('div');
      rejectionRateLabel.className = 'rejection-metric-label';
      rejectionRateLabel.textContent = 'Rejection Rate';
      rejectionRateStat.appendChild(rejectionRateValue);
      rejectionRateStat.appendChild(rejectionRateLabel);
      branchStats.appendChild(rejectionRateStat);
      
      // Top rejecting branch stat
      const topBranchStat = document.createElement('div');
      topBranchStat.className = 'rejection-metric-item';
      const topBranchValue = document.createElement('div');
      topBranchValue.className = 'rejection-metric-value';
      const topBranch = Object.keys(branchRejections).reduce((a, b) => 
        branchRejections[a].count > branchRejections[b].count ? a : b, '-');
      topBranchValue.textContent = topBranch;
      const topBranchLabel = document.createElement('div');
      topBranchLabel.className = 'rejection-metric-label';
      topBranchLabel.textContent = 'Top Branch';
      topBranchStat.appendChild(topBranchValue);
      topBranchStat.appendChild(topBranchLabel);
      branchStats.appendChild(topBranchStat);
      
      branchCard.appendChild(branchStats);
      grid.appendChild(branchCard);
      
      // Create a card for platform rejections
      const platformCard = document.createElement('div');
      platformCard.className = 'rejection-card';
      
      const platformHeader = document.createElement('h6');
      platformHeader.textContent = 'Rejections by Platform';
      platformCard.appendChild(platformHeader);
      
      // Create stats
      const platformStats = document.createElement('div');
      platformStats.className = 'rejection-stats';
      
      // Noon rejections stat
      const noonRejectionsStat = document.createElement('div');
      noonRejectionsStat.className = 'rejection-metric-item';
      const noonRejectionsValue = document.createElement('div');
      noonRejectionsValue.className = 'rejection-metric-value';
      const noonRejections = rejectedTickets.filter(t => t.platform === 'Noon').length;
      noonRejectionsValue.textContent = noonRejections;
      const noonRejectionsLabel = document.createElement('div');
      noonRejectionsLabel.className = 'rejection-metric-label';
      noonRejectionsLabel.textContent = 'Noon Rejections';
      noonRejectionsStat.appendChild(noonRejectionsValue);
      noonRejectionsStat.appendChild(noonRejectionsLabel);
      platformStats.appendChild(noonRejectionsStat);
      
      // Careem rejections stat
      const careemRejectionsStat = document.createElement('div');
      careemRejectionsStat.className = 'rejection-metric-item';
      const careemRejectionsValue = document.createElement('div');
      careemRejectionsValue.className = 'rejection-metric-value';
      const careemRejections = rejectedTickets.filter(t => t.platform === 'Careem').length;
      careemRejectionsValue.textContent = careemRejections;
      const careemRejectionsLabel = document.createElement('div');
      careemRejectionsLabel.className = 'rejection-metric-label';
      careemRejectionsLabel.textContent = 'Careem Rejections';
      careemRejectionsStat.appendChild(careemRejectionsValue);
      careemRejectionsStat.appendChild(careemRejectionsLabel);
      platformStats.appendChild(careemRejectionsStat);
      
      // Noon rejection rate stat
      const noonRejectionRateStat = document.createElement('div');
      noonRejectionRateStat.className = 'rejection-metric-item';
      const noonRejectionRateValue = document.createElement('div');
      noonRejectionRateValue.className = 'rejection-metric-value';
      const noonTickets = tickets.filter(t => t.platform === 'Noon').length;
      const noonRejectionRate = noonTickets > 0 ? ((noonRejections / noonTickets) * 100).toFixed(1) : 0;
      noonRejectionRateValue.textContent = `${noonRejectionRate}%`;
      const noonRejectionRateLabel = document.createElement('div');
      noonRejectionRateLabel.className = 'rejection-metric-label';
      noonRejectionRateLabel.textContent = 'Noon Rate';
      noonRejectionRateStat.appendChild(noonRejectionRateValue);
      noonRejectionRateStat.appendChild(noonRejectionRateLabel);
      platformStats.appendChild(noonRejectionRateStat);
      
      // Careem rejection rate stat
      const careemRejectionRateStat = document.createElement('div');
      careemRejectionRateStat.className = 'rejection-metric-item';
      const careemRejectionRateValue = document.createElement('div');
      careemRejectionRateValue.className = 'rejection-metric-value';
      const careemTickets = tickets.filter(t => t.platform === 'Careem').length;
      const careemRejectionRate = careemTickets > 0 ? ((careemRejections / careemTickets) * 100).toFixed(1) : 0;
      careemRejectionRateValue.textContent = `${careemRejectionRate}%`;
      const careemRejectionRateLabel = document.createElement('div');
      careemRejectionRateLabel.className = 'rejection-metric-label';
      careemRejectionRateLabel.textContent = 'Careem Rate';
      careemRejectionRateStat.appendChild(careemRejectionRateValue);
      careemRejectionRateStat.appendChild(careemRejectionRateLabel);
      platformStats.appendChild(careemRejectionRateStat);
      
      platformCard.appendChild(platformStats);
      grid.appendChild(platformCard);
      
      container.appendChild(grid);
    }
    
    function updateRestaurantFaultAnalysis() {
      const container = document.getElementById('restaurantFaultContainer');
      container.innerHTML = '';
      
      // Get restaurant fault tickets
      const faultTickets = tickets.filter(t => t.status === 'Restaurant Fault');
      
      if (faultTickets.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No restaurant fault cases found</p>';
        return;
      }
      
      // Create grid
      const grid = document.createElement('div');
      grid.className = 'rejection-analysis-grid';
      
      // Create a card for restaurant fault analysis
      const card = document.createElement('div');
      card.className = 'rejection-card';
      
      const header = document.createElement('h6');
      header.textContent = 'Restaurant Fault Analysis';
      card.appendChild(header);
      
      // Create stats
      const stats = document.createElement('div');
      stats.className = 'rejection-stats';
      
      // Total fault cases stat
      const totalFaultStat = document.createElement('div');
      totalFaultStat.className = 'rejection-metric-item';
      const totalFaultValue = document.createElement('div');
      totalFaultValue.className = 'rejection-metric-value';
      totalFaultValue.textContent = faultTickets.length;
      const totalFaultLabel = document.createElement('div');
      totalFaultLabel.className = 'rejection-metric-label';
      totalFaultLabel.textContent = 'Total Fault Cases';
      totalFaultStat.appendChild(totalFaultValue);
      totalFaultStat.appendChild(totalFaultLabel);
      stats.appendChild(totalFaultStat);
      
      // Total compensation stat
      const totalCompensationStat = document.createElement('div');
      totalCompensationStat.className = 'rejection-metric-item';
      const totalCompensationValue = document.createElement('div');
      totalCompensationValue.className = 'rejection-metric-value';
      const totalCompensation = faultTickets.reduce((sum, t) => sum + (t.compensation || 0), 0);
      totalCompensationValue.textContent = totalCompensation.toFixed(2);
      const totalCompensationLabel = document.createElement('div');
      totalCompensationLabel.className = 'rejection-metric-label';
      totalCompensationLabel.textContent = 'Total Compensation';
      totalCompensationStat.appendChild(totalCompensationValue);
      totalCompensationStat.appendChild(totalCompensationLabel);
      stats.appendChild(totalCompensationStat);
      
      // Fault rate stat
      const faultRateStat = document.createElement('div');
      faultRateStat.className = 'rejection-metric-item';
      const faultRateValue = document.createElement('div');
      faultRateValue.className = 'rejection-metric-value';
      const faultRate = tickets.length > 0 ? ((faultTickets.length / tickets.length) * 100).toFixed(1) : 0;
      faultRateValue.textContent = `${faultRate}%`;
      const faultRateLabel = document.createElement('div');
      faultRateLabel.className = 'rejection-metric-label';
      faultRateLabel.textContent = 'Fault Rate';
      faultRateStat.appendChild(faultRateValue);
      faultRateStat.appendChild(faultRateLabel);
      stats.appendChild(faultRateStat);
      
      // Average compensation stat
      const avgCompensationStat = document.createElement('div');
      avgCompensationStat.className = 'rejection-metric-item';
      const avgCompensationValue = document.createElement('div');
      avgCompensationValue.className = 'rejection-metric-value';
      const avgCompensation = faultTickets.length > 0 ? (totalCompensation / faultTickets.length).toFixed(2) : 0;
      avgCompensationValue.textContent = avgCompensation;
      const avgCompensationLabel = document.createElement('div');
      avgCompensationLabel.className = 'rejection-metric-label';
      avgCompensationLabel.textContent = 'Avg. Compensation';
      avgCompensationStat.appendChild(avgCompensationValue);
      avgCompensationStat.appendChild(avgCompensationLabel);
      stats.appendChild(avgCompensationStat);
      
      card.appendChild(stats);
      grid.appendChild(card);
      
      container.appendChild(grid);
    }
    
    function updateRefundAnalysis() {
      // Get refunded tickets
      const refundedTickets = tickets.filter(t => t.refundedAmount > 0);
      
      // Update refund metrics
      const totalRefundedAmount = refundedTickets.reduce((sum, t) => sum + (t.refundedAmount || 0), 0);
      const refundedCasesCount = refundedTickets.length;
      const refundRate = tickets.length > 0 ? ((refundedCasesCount / tickets.length) * 100).toFixed(1) : 0;
      const avgRefundedAmount = refundedCasesCount > 0 ? (totalRefundedAmount / refundedCasesCount).toFixed(2) : 0;
      
      document.getElementById('totalRefundedAmount').textContent = totalRefundedAmount.toFixed(2);
      document.getElementById('refundedCasesCount').textContent = refundedCasesCount;
      document.getElementById('refundRate').textContent = `${refundRate}%`;
      document.getElementById('avgRefundedAmount').textContent = avgRefundedAmount;
      
      // Update refund branch chart
      const refundBranchCtx = document.getElementById('refundBranchChart').getContext('2d');
      
      // Group refunded tickets by branch
      const branchRefunds = {};
      refundedTickets.forEach(ticket => {
        if (!branchRefunds[ticket.branch]) {
          branchRefunds[ticket.branch] = 0;
        }
        branchRefunds[ticket.branch] += (ticket.refundedAmount || 0);
      });
      
      const topBranchRefunds = Object.keys(branchRefunds)
        .sort((a, b) => branchRefunds[b] - branchRefunds[a])
        .slice(0, 5);
      
      if (refundBranchChart) refundBranchChart.destroy();
      
      refundBranchChart = new Chart(refundBranchCtx, {
        type: 'bar',
        data: {
          labels: topBranchRefunds,
          datasets: [{
            label: 'Refunded Amount',
            data: topBranchRefunds.map(branch => branchRefunds[branch]),
            backgroundColor: 'rgba(40, 167, 69, 0.5)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Update refund table
      const tableBody = document.getElementById('refundTableBody');
      tableBody.innerHTML = '';
      
      // Sort refunded tickets by date (newest first)
      const sortedRefundedTickets = [...refundedTickets].sort((a, b) => {
        return new Date(b.orderDate) - new Date(a.orderDate);
      });
      
      // Show only the last 10 refunded tickets
      const recentRefundedTickets = sortedRefundedTickets.slice(0, 10);
      
      recentRefundedTickets.forEach(ticket => {
        const row = document.createElement('tr');
        
        // Order ID
        const orderIdCell = document.createElement('td');
        orderIdCell.textContent = ticket.orderId;
        row.appendChild(orderIdCell);
        
        // Branch
        const branchCell = document.createElement('td');
        branchCell.textContent = ticket.branch;
        row.appendChild(branchCell);
        
        // Original Amount
        const originalAmountCell = document.createElement('td');
        originalAmountCell.textContent = (ticket.originalAmount || 0).toFixed(2);
        row.appendChild(originalAmountCell);
        
        // Compensation
        const compensationCell = document.createElement('td');
        compensationCell.textContent = (ticket.compensation || 0).toFixed(2);
        row.appendChild(compensationCell);
        
        // Refunded Amount
        const refundedAmountCell = document.createElement('td');
        refundedAmountCell.textContent = (ticket.refundedAmount || 0).toFixed(2);
        row.appendChild(refundedAmountCell);
        
        // Status
        const statusCell = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.className = 'refund-status-badge status-refunded';
        statusBadge.textContent = 'Refunded';
        statusCell.appendChild(statusBadge);
        row.appendChild(statusCell);
        
        // Date
        const dateCell = document.createElement('td');
        const date = new Date(ticket.orderDate || ticket.dateCreated);
        dateCell.textContent = date.toLocaleDateString();
        row.appendChild(dateCell);
        
        tableBody.appendChild(row);
      });
      
      if (recentRefundedTickets.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 7;
        cell.className = 'text-center text-muted';
        cell.textContent = 'No refunded cases found';
        row.appendChild(cell);
        tableBody.appendChild(row);
      }
    }
    
    function renderTicketsTable() {
      ticketsTableBody.innerHTML = '';
      
      // Sort tickets by date (newest first)
      const sortedTickets = [...tickets].sort((a, b) => {
        return new Date(b.orderDate || b.dateCreated) - new Date(a.orderDate || a.dateCreated);
      });
      
      // Render tickets
      sortedTickets.forEach(ticket => {
        const row = document.createElement('tr');
        
        // Add class based on status
        if (ticket.status === 'Closed' && ticket.refundedAmount > 0) {
          row.classList.add('refunded-case');
        } else if (ticket.status === 'Rejected') {
          row.classList.add('rejected-case');
        } else if (ticket.status === 'Restaurant Fault') {
          row.classList.add('restaurant-fault');
        } else if (parseFloat(ticket.compensation) > 50) {
          row.classList.add('high-compensation');
        }
        
        // Order ID
        const orderIdCell = document.createElement('td');
        const orderId = document.createElement('div');
        orderId.className = 'ticket-order-id';
        orderId.textContent = ticket.orderId;
        orderIdCell.appendChild(orderId);
        row.appendChild(orderIdCell);
        
        // Order Date
        const orderDateCell = document.createElement('td');
        const orderDate = document.createElement('div');
        orderDate.className = 'ticket-order-date';
        orderDate.textContent = new Date(ticket.orderDate || ticket.dateCreated).toLocaleDateString();
        orderDateCell.appendChild(orderDate);
        row.appendChild(orderDateCell);
        
        // Branch
        const branchCell = document.createElement('td');
        const branch = document.createElement('div');
        branch.className = 'ticket-branch';
        branch.textContent = ticket.branch;
        branchCell.appendChild(branch);
        row.appendChild(branchCell);
        
        // Platform
        const platformCell = document.createElement('td');
        const platform = document.createElement('span');
        platform.className = `ticket-platform ${ticket.platform.toLowerCase()}`;
        platform.textContent = ticket.platform;
        platformCell.appendChild(platform);
        row.appendChild(platformCell);
        
        // Issue
        const issueCell = document.createElement('td');
        const issueContainer = document.createElement('div');
        issueContainer.className = 'd-flex align-items-center';
        
        const issue = document.createElement('div');
        issue.className = 'ticket-issue';
        issue.textContent = ticket.issue.length > 30 ? 
          `${ticket.issue.substring(0, 30)}...` : ticket.issue;
        issue.title = ticket.issue;
        issueContainer.appendChild(issue);
        
        if (ticket.issue.length > 30) {
          const expandBtn = document.createElement('button');
          expandBtn.className = 'issue-expand';
          expandBtn.textContent = 'more';
          expandBtn.onclick = function() {
            if (issue.textContent.endsWith('...')) {
              issue.textContent = ticket.issue;
              expandBtn.textContent = 'less';
            } else {
              issue.textContent = `${ticket.issue.substring(0, 30)}...`;
              expandBtn.textContent = 'more';
            }
          };
          issueContainer.appendChild(expandBtn);
        }
        
        issueCell.appendChild(issueContainer);
        row.appendChild(issueCell);
        
        // Evidence
        const evidenceCell = document.createElement('td');
        const evidence = document.createElement('div');
        evidence.className = 'ticket-evidence';
        
        if (ticket.evidence && ticket.evidence !== 'None') {
          if (ticket.evidence.startsWith('data:image')) {
            const thumbnail = document.createElement('div');
            thumbnail.className = 'evidence-thumbnail';
            
            const img = document.createElement('img');
            img.src = ticket.evidence;
            img.style.width = '30px';
            img.style.height = '30px';
            img.style.objectFit = 'cover';
            
            thumbnail.appendChild(img);
            evidence.appendChild(thumbnail);
          } else if (ticket.evidence.startsWith('http')) {
            const link = document.createElement('a');
            link.className = 'ticket-evidence-link';
            link.href = ticket.evidence;
            link.target = '_blank';
            link.innerHTML = '<i class="bi bi-link-45deg"></i>';
            evidence.appendChild(link);
          }
        } else {
          const none = document.createElement('div');
          none.className = 'ticket-evidence-none';
          none.textContent = 'None';
          evidence.appendChild(none);
        }
        
        evidenceCell.appendChild(evidence);
        row.appendChild(evidenceCell);
        
        // Status
        const statusCell = document.createElement('td');
        const status = document.createElement('span');
        status.className = `status-badge status-${ticket.status.toLowerCase().replace(' ', '-')}`;
        status.textContent = ticket.status;
        statusCell.appendChild(status);
        row.appendChild(statusCell);
        
        // Original Amount
        const originalAmountCell = document.createElement('td');
        const originalAmount = document.createElement('div');
        originalAmount.className = 'ticket-amount';
        originalAmount.textContent = (ticket.originalAmount || 0).toFixed(2);
        originalAmountCell.appendChild(originalAmount);
        row.appendChild(originalAmountCell);
        
        // Compensation
        const compensationCell = document.createElement('td');
        const compensation = document.createElement('div');
        compensation.className = 'ticket-amount compensation';
        compensation.textContent = (ticket.compensation || 0).toFixed(2);
        compensationCell.appendChild(compensation);
        row.appendChild(compensationCell);
        
        // Refunded
        const refundedCell = document.createElement('td');
        const refunded = document.createElement('div');
        refunded.className = 'ticket-amount refunded';
        refunded.textContent = (ticket.refundedAmount || 0).toFixed(2);
        refundedCell.appendChild(refunded);
        row.appendChild(refundedCell);
        
        // Actions
        const actionsCell = document.createElement('td');
        const actions = document.createElement('div');
        actions.className = 'ticket-actions';
        
        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.title = 'Edit';
        editBtn.onclick = function() {
          openEditModal(ticket.id);
        };
        actions.appendChild(editBtn);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-sm btn-outline-danger';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        deleteBtn.title = 'Delete';
        deleteBtn.onclick = function() {
          deleteTicket(ticket.id);
        };
        actions.appendChild(deleteBtn);
        
        actionsCell.appendChild(actions);
        row.appendChild(actionsCell);
        
        ticketsTableBody.appendChild(row);
      });
      
      // If no tickets, show empty state
      if (tickets.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 11;
        cell.innerHTML = `
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h5>No compensation cases found</h5>
            <p>Add a new case or upload data from Excel/CSV</p>
            <button class="btn btn-primary" onclick="openAddModal()">
              <i class="bi bi-plus-circle"></i> Add New Case
            </button>
          </div>
        `;
        row.appendChild(cell);
        ticketsTableBody.appendChild(row);
      }
    }
    
    function openEditModal(id) {
      const ticket = tickets.find(t => t.id === id);
      if (!ticket) return;
      
      // Populate form
      document.getElementById('editingId').value = ticket.id;
      document.getElementById('f_orderId').value = ticket.orderId;
      document.getElementById('f_orderDate').value = ticket.orderDate;
      document.getElementById('f_branch').value = ticket.branch;
      document.getElementById('f_platform').value = ticket.platform;
      document.getElementById('f_issue').value = ticket.issue;
      document.getElementById('f_originalAmount').value = ticket.originalAmount || 0;
      document.getElementById('f_compensation').value = ticket.compensation || 0;
      document.getElementById('f_refundedAmount').value = ticket.refundedAmount || 0;
      document.getElementById('f_isRefunded').checked = ticket.isRefunded || false;
      document.getElementById('f_refundDate').value = ticket.refundDate || '';
      document.getElementById('f_noEvidence').checked = ticket.evidence === 'None';
      document.getElementById('f_shortLink').value = ticket.shortLink || '';
      
      // Set evidence image
      if (ticket.evidence && ticket.evidence !== 'None' && ticket.evidence.startsWith('data:image')) {
        document.getElementById('imagePreview').src = ticket.evidence;
        document.getElementById('imagePreview').style.display = 'block';
      } else {
        document.getElementById('imagePreview').style.display = 'none';
      }
      
      // Update modal title
      document.getElementById('modalTitle').textContent = 'Edit Magical Compensation Case';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
      modal.show();
      
      addCommand(`Opened edit case modal for ${ticket.orderId}`);
    }
    
    function deleteTicket(id) {
      if (confirm('Are you sure you want to delete this case?')) {
        // Find ticket
        const ticket = tickets.find(t => t.id === id);
        if (!ticket) return;
        
        // Delete ticket
        tickets = tickets.filter(t => t.id !== id);
        
        // Save data
        if (save()) {
          // Update UI
          renderAll();
          showNotification('Case deleted successfully', 'success');
          addCommand(`Deleted case ${ticket.orderId}`);
        }
      }
    }
    
    function addSample() {
      // Sample data
      const sampleTickets = [
        {
          id: Date.now().toString(),
          orderId: 'ORD-001',
          orderDate: new Date().toISOString(),
          branch: 'Crispy Chicken Khalidiya',
          platform: 'Noon',
          status: 'Closed',
          originalAmount: 85.50,
          compensation: 25.00,
          refundedAmount: 25.00,
          isRefunded: true,
          refundDate: new Date().toISOString().split('T')[0],
          issue: 'Wrong item delivered',
          evidence: 'None',
          shortLink: '',
          dateCreated: new Date().toISOString()
        },
        {
          id: (Date.now() + 1).toString(),
          orderId: 'ORD-002',
          orderDate: new Date(Date.now() - 86400000).toISOString(),
          branch: 'Crispy Chicken Muroor',
          platform: 'Careem',
          status: 'Open',
          originalAmount: 120.00,
          compensation: 40.00,
          refundedAmount: 0,
          isRefunded: false,
          refundDate: '',
          issue: 'Late delivery',
          evidence: 'None',
          shortLink: '',
          dateCreated: new Date(Date.now() - 86400000).toISOString()
        },
        {
          id: (Date.now() + 2).toString(),
          orderId: 'ORD-003',
          orderDate: new Date(Date.now() - 172800000).toISOString(),
          branch: 'Crispy Chicken Shabiya 11',
          platform: 'Noon',
          status: 'Rejected',
          originalAmount: 65.00,
          compensation: 20.00,
          refundedAmount: 0,
          isRefunded: false,
          refundDate: '',
          issue: 'Missing items',
          evidence: 'None',
          shortLink: '',
          dateCreated: new Date(Date.now() - 172800000).toISOString()
        }
      ];
      
      // Add sample tickets
      tickets.push(...sampleTickets);
      
      // Save data
      if (save()) {
        // Update UI
        renderAll();
        showNotification('Sample data added successfully', 'success');
        addCommand('Added sample data');
      }
    }
    
    // ===== Toggle Heatmap =====
    function toggleHeatmap() {
      heatmapVisible = !heatmapVisible;
      const heatmapToggleBtn = document.getElementById('heatmapToggleBtn');
